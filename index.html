<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti</title>
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile personalizzato per il corpo e i pulsanti */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
            width: 95%;
            margin-bottom: 1.5rem; 
        }
        .vote-btn {
            transition: all 0.2s;
            transform: scale(1.0);
        }
        .vote-btn:hover:not(.opacity-50):not(.bg-blue-800) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .vote-btn:active:not(.opacity-50):not(.bg-blue-800) {
            transform: scale(0.98);
        }
        .log-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
    <!-- Configurazione del Font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- Libreria Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/index.umd.min.js"></script>
    <!-- Libreria Lucide (Icone) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>

<!-- CONTENITORE PRINCIPALE (Registrazione/Votazione/Log) -->
<div id="app-container" class="container-card">
    <div id="main-content">
        <p class="text-center text-gray-500">Inizializzazione Supabase...</p>
    </div>
</div>

<!-- PANNELLO ADMIN SEPARATO -->
<div id="admin-panel" class="hidden bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-300 max-w-[480px] w-[95%]">
    <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Pannello di Controllo Dirigente</h3>
    
    <!-- Contatori Principali -->
    <div class="grid grid-cols-3 gap-2 text-center mb-4">
        <div>
            <p class="text-2xl font-bold text-blue-600" id="total-attendees">0</p>
            <p class="text-xs text-gray-500">Presenti</p>
        </div>
        <div>
            <p class="text-2xl font-bold text-yellow-600" id="total-voted">0</p>
            <p class="text-xs text-gray-500">Votanti</p>
        </div>
        <div>
            <p class="text-2xl font-bold text-gray-600" id="percent-voted">0%</p>
            <p class="text-xs text-gray-500">Quota</p>
        </div>
    </div>

    <!-- SEZIONE GESTIONE CODICE -->
    <h4 class="text-lg font-bold text-gray-800 mt-4 border-t pt-4">1. Configurazione Voto</h4>
    <p class="text-sm text-gray-700 mb-2">Codice Corrente Richiesto: <span id="current-required-code" class="font-mono text-sm bg-blue-100 p-1 rounded font-bold">Nessuno</span></p>
    <div class="flex space-x-2 mb-4">
        <input type="text" id="admin-set-code" placeholder="Codice Univoco (es. 1234)" class="w-2/3 p-2 border border-gray-400 rounded-lg text-sm" />
        <button id="update-code-btn" class="w-1/3 py-2 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md">
            Imposta
        </button>
    </div>

    <!-- SEZIONE GESTIONE VOTO -->
    <h4 class="text-lg font-bold text-red-700 mt-6 border-t pt-4">2. Votazione e Azioni</h4>
    <p class="text-sm text-gray-700 mb-4">Stato Votazione: <span id="voting-status-text" class="font-bold text-red-600">DISATTIVO</span>.</p>
    
    <div class="space-y-2 mt-4">
        <button id="toggle-voting-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md">
            Attiva Votazione
        </button>
        <button id="reset-results-btn" class="w-full py-2 px-4 rounded-xl text-red-700 border border-red-700 bg-white hover:bg-red-50 transition duration-150 ease-in-out font-semibold shadow-sm">
            Resetta Voti (Salva Report)
        </button>
    </div>

    <!-- SEZIONE LOG E RESET TOTALE -->
    <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4">3. Log e Reset Progetto</h4>
    <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="show-deliberations-btn" class="py-2 px-2 rounded-xl text-purple-700 border border-purple-700 bg-white hover:bg-purple-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            Mostra Log Storico
        </button>
        <button id="reset-project-btn" class="py-2 px-2 rounded-xl text-white border border-gray-600 bg-gray-600 hover:bg-gray-700 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            RESET TOTALE
        </button>
    </div>
</div>

<!-- Script Logica Applicativa (Supabase) -->
<script>
    // Inizializzazione delle costanti globali
    let supabase = null;
    let userId = null;
    let isRegistered = false;
    let isVotingActive = false;
    let hasVotedInCurrentRound = false;
    let votingResults = { Favorevole: 0, Contrario: 0, Astenuto: 0 };
    let requiredCode = null; 
    let isViewingLog = false; 
    let isAdminRole = false; 
    let lastResetTimestamp = 0; 
    let initialised = false; // Flag per la correzione del ReferenceError

    // Credenziali Supabase (INSERITE AUTOMATICAMENTE)
    const SUPABASE_URL = 'https://iuuvakwbuequapwoyddd.supabase.co'; 
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dXZha3didWVxdWFwd295ZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTE5ODEsImV4cCI6MjA3Njg4Nzk4MX0.c7BpXAk8hF0lijNnWaURjQxsZDBv66JvV8NJ1xxX-KI'; 

    // Elementi UI
    const mainContentEl = document.getElementById('main-content');
    const adminPanelEl = document.getElementById('admin-panel');
    
    // Elementi Admin
    const totalAttendeesEl = document.getElementById('total-attendees');
    const totalVotedEl = document.getElementById('total-voted');
    const percentVotedEl = document.getElementById('percent-voted');
    const toggleVotingBtn = document.getElementById('toggle-voting-btn');
    const resetResultsBtn = document.getElementById('reset-results-btn');
    const updateCodeBtn = document.getElementById('update-code-btn'); 
    const votingStatusTextEl = document.getElementById('voting-status-text');
    const currentRequiredCodeEl = document.getElementById('current-required-code'); 
    const showDeliberationsBtn = document.getElementById('show-deliberations-btn'); 
    const resetProjectBtn = document.getElementById('reset-project-btn'); 

    // --- FUNZIONI DI UTILITÀ E SETUP ---

    function getUserId() {
        let uid = localStorage.getItem('votingAppUserId');
        if (!uid) {
            uid = crypto.randomUUID();
            localStorage.setItem('votingAppUserId', uid);
        }
        return uid;
    }

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function formatTimestamp(timestampStr) {
        if (!timestampStr) return 'N/A';
        const date = new Date(timestampStr);
        return date.toLocaleDateString('it-IT', {
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    function showMessage(message, isError = false) {
        const type = isError ? 'bg-red-500' : 'bg-green-500';
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-semibold ${type} shadow-xl z-50 transition-opacity duration-300`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.addEventListener('transitionend', () => messageEl.remove());
        }, 3000);
    }
    
    // Inizializza Supabase (Corretto l'errore di scoping)
    function initializeSupabase() {
        try {
            // Utilizza l'oggetto globale Supabase creato dal tag script
            if (typeof supabase == 'undefined' && typeof window.supabase == 'object') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_API_KEY, {
                    db: { schema: 'public' },
                    auth: { persistSession: false },
                    realtime: {
                        params: {
                            eventsPerSecond: 1
                        }
                    }
                });
                console.log("Supabase Client inizializzato con successo.");
            } else if (typeof supabase == 'object') {
                 console.log("Supabase Client già inizializzato.");
            } else {
                 throw new Error("La libreria Supabase non è stata caricata correttamente.");
            }
        } catch (e) {
            console.error("Errore fatale nell'inizializzazione di Supabase:", e);
            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-red-700 text-center mb-6">ERRORE DI CONFIGURAZIONE</h2>
                <p class="text-gray-700 mb-4">Impossibile connettersi a Supabase. Verifica le credenziali e che il database sia configurato.</p>
                <p class="text-sm text-gray-600">Errore: ${e.message}</p>
            `;
            throw e;
        }
    }


    // --- FUNZIONI DI LOGICA E DATI (API Supabase) ---

    // Recupera lo stato, i risultati e le presenze
    async function fetchSettingsAndVotes() {
        if (!supabase) return { error: true, message: "Client Supabase non disponibile." };

        try {
            // 1. Fetch Settings (Stato Voto e Codice)
            const { data: settingsData, error: settingsError } = await supabase
                .from('settings')
                .select('is_voting_active, required_code, last_reset')
                .limit(1)
                .single();

            if (settingsError && settingsError.code !== 'PGRST116') { // PGRST116 = No rows returned (Prima inizializzazione)
                throw new Error("Errore fetch settings: " + settingsError.message);
            }
            
            // 2. Fetch Voti e Contatori (Utilizzando la funzione RPC SQL)
            const { data: voteCounts, error: votesError } = await supabase
                .rpc('get_vote_counts');
            
            if (votesError) {
                throw new Error("Errore fetch vote counts: " + votesError.message);
            }

            const counts = voteCounts[0] || {};
            const totalPresenti = parseInt(counts.attendee_count) || 0;
            const totalVotanti = parseInt(counts.total_votes)