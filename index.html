<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti</title>
    <!-- Caricamento di Tailwind CSS con Cache Busting -->
    <script>
        const tailwindSrc = `https://cdn.tailwindcss.com?v=${Date.now()}`;
        const scriptTag = document.createElement('script');
        scriptTag.src = tailwindSrc;
        document.head.appendChild(scriptTag);
    </script>
    <style>
        /* Stile personalizzato */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 2rem 1rem; }
        .container-card { background-color: white; padding: 2rem; border-radius: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); max-width: 480px; width: 95%; margin-bottom: 1.5rem; }
        .vote-btn { transition: all 0.2s; transform: scale(1.0); }
        .vote-btn:hover:not(.opacity-50):not(.bg-blue-800) { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .vote-btn:active:not(.opacity-50):not(.bg-blue-800) { transform: scale(0.98); }
        .log-list { max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 0.5rem; }
    </style>
    <!-- Configurazione Font Inter -->
    <script>
        tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } } }
    </script>
    <!-- Librerie Supabase e Lucide con Cache Busting -->
    <script>
        const supabaseSrc = `https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js?v=${Date.now()}`;
        const lucideSrc = `https://unpkg.com/lucide@latest/dist/umd/lucide.js?v=${Date.now()}`;
        function loadScript(src) { /* ... (funzione loadScript come prima) ... */
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        Promise.all([loadScript(supabaseSrc), loadScript(lucideSrc)])
            .then(() => {
                console.log("Librerie caricate.");
                if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initApp); }
                else { initApp(); }
            })
            .catch(error => { /* ... (gestione errore caricamento librerie come prima) ... */
                 console.error("Errore caricamento librerie:", error);
                 const mainContentEl = document.getElementById('main-content');
                 if(mainContentEl) mainContentEl.innerHTML = `<p class="text-center text-red-500">Errore caricamento librerie. Ricarica.</p>`;
            });
    </script>
</head>
<body>

<!-- CONTENITORE PRINCIPALE -->
<div id="app-container" class="container-card">
    <div id="main-content">
        <p class="text-center text-gray-500">Inizializzazione Supabase...</p>
    </div>
</div>

<!-- PANNELLO ADMIN SEPARATO -->
<div id="admin-panel" class="hidden bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-300 max-w-[480px] w-[95%]">
    <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Pannello di Controllo Dirigente</h3>
    <div class="grid grid-cols-3 gap-2 text-center mb-4">
        <div> <p class="text-2xl font-bold text-blue-600" id="total-attendees">0</p> <p class="text-xs text-gray-500">Presenti</p> </div>
        <div> <p class="text-2xl font-bold text-yellow-600" id="total-voted">0</p> <p class="text-xs text-gray-500">Votanti</p> </div>
        <div> <p class="text-2xl font-bold text-gray-600" id="percent-voted">0%</p> <p class="text-xs text-gray-500">Quota</p> </div>
    </div>

    <!-- SEZIONE GESTIONE VOTO (Senza codice univoco) -->
    <h4 class="text-lg font-bold text-red-700 mt-6 border-t pt-4">1. Votazione e Azioni</h4>
    <p class="text-sm text-gray-700 mb-4">Stato Votazione: <span id="voting-status-text" class="font-bold text-red-600">DISATTIVO</span>.</p>
    <div class="space-y-2 mt-4">
        <button id="toggle-voting-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition bg-red-600 hover:bg-red-700 shadow-md"> Attiva Votazione </button>
        <button id="reset-results-btn" class="w-full py-2 px-4 rounded-xl text-red-700 border border-red-700 bg-white hover:bg-red-50 transition font-semibold shadow-sm"> Resetta Voti (Salva Report) </button>
    </div>

    <!-- SEZIONE LOG E RESET TOTALE -->
    <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4">2. Log e Reset Progetto</h4>
    <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="show-deliberations-btn" class="py-2 px-2 rounded-xl text-purple-700 border border-purple-700 bg-white hover:bg-purple-50 transition font-semibold text-sm shadow-sm"> Mostra Log Storico </button>
        <button id="reset-project-btn" class="py-2 px-2 rounded-xl text-white border border-gray-600 bg-gray-600 hover:bg-gray-700 transition font-semibold text-sm shadow-sm"> RESET TOTALE </button>
    </div>
</div>

<!-- Script Logica Applicativa (Supabase) -->
<script>
    // Inizializzazione variabili globali
    let supabase = null;
    let userId = null;
    let isRegistered = false;
    let isVotingActive = false;
    let hasVotedInCurrentRound = false;
    let votingResults = { Favorevole: 0, Contrario: 0, Astenuto: 0 };
    // let requiredCode = null; // RIMOSSO
    let isViewingLog = false;
    let isAdminRole = false;
    let initialised = false;

    // Credenziali Supabase (DA SOSTITUIRE!)
    const SUPABASE_URL = 'https://iuuvakwbuequapwoyddd.supabase.co'; // <-- INCOLLA URL QUI
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dXZha3didWVxdWFwd295ZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTE5ODEsImV4cCI6MjA3Njg4Nzk4MX0.c7BpXAk8hF0lijNnWaURjQxsZDBv66JvV8NJ1xxX-KI'; // <-- INCOLLA CHIAVE QUI

    // Elementi UI
    const mainContentEl = document.getElementById('main-content');
    const adminPanelEl = document.getElementById('admin-panel');
    let totalAttendeesEl, totalVotedEl, percentVotedEl, toggleVotingBtn, resetResultsBtn, /* updateCodeBtn, */ votingStatusTextEl, /* currentRequiredCodeEl, */ showDeliberationsBtn, resetProjectBtn;


    // --- FUNZIONI DI UTILITÀ E SETUP ---
    function getUserId() { /* ... (come prima) ... */
        let uid = localStorage.getItem('votingAppUserId');
        if (!uid) { uid = crypto.randomUUID(); localStorage.setItem('votingAppUserId', uid); }
        return uid;
     }
    function getUrlParameter(name) { /* ... (come prima) ... */
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
     }
    function formatTimestamp(timestampStr) { /* ... (come prima) ... */
        if (!timestampStr) return 'N/A';
        const date = new Date(timestampStr);
        return date.toLocaleDateString('it-IT', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
     }
    function showMessage(message, isError = false) { /* ... (come prima) ... */
        const existingMessages = document.querySelectorAll('.fixed.top-5');
        existingMessages.forEach(msg => msg.remove());
        const type = isError ? 'bg-red-500' : 'bg-green-500';
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-semibold ${type} shadow-xl z-50 transition-opacity duration-300`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);
        setTimeout(() => { messageEl.style.opacity = '0'; messageEl.addEventListener('transitionend', () => messageEl.remove()); }, 3000);
     }
    function initializeSupabase() { /* ... (come prima, robusta) ... */
        try {
            const cleanApiKey = SUPABASE_API_KEY.trim(); const cleanUrl = SUPABASE_URL.trim();
            if (!cleanUrl || !cleanApiKey || cleanUrl.includes('[') || cleanApiKey.includes('[')) { throw new Error("Credenziali Supabase mancanti."); }
            if (typeof window.supabase === 'object' && typeof window.supabase.createClient === 'function') {
                supabase = window.supabase.createClient( cleanUrl, cleanApiKey, { db: { schema: 'public' }, auth: { persistSession: false }, realtime: { params: { eventsPerSecond: 1 } } });
                console.log("Supabase Client inizializzato.");
                initialised = true;
            } else { throw new Error("Libreria Supabase non caricata."); }
        } catch (e) {
            console.error("Errore init Supabase:", e);
            mainContentEl.innerHTML = `<h2 class="text-2xl font-bold text-red-700">ERRORE FATALE</h2><p>${e.message}</p>`;
        }
    }

    // --- FUNZIONI DI LOGICA E DATI ---
    async function fetchSettingsAndVotes() { /* ... (come prima, ma senza requiredCode) ... */
        if (!initialised || !supabase) return;
        try {
            // Fetch Settings (solo stato voto e reset)
            const { data: settingsData, error: settingsError } = await supabase.from('settings').select('is_voting_active, last_reset').limit(1).single();
            if (settingsError && settingsError.code !== 'PGRST116') {
                 if (settingsError.code === '42501') showMessage("Errore permessi DB (RLS). Esegui SQL.", true);
                 else showMessage(`Errore DB settings: ${settingsError.message}`, true);
                 console.error("Errore fetch settings:", settingsError); return;
            }

            // Fetch Conteggi
            let counts = { attendee_count: 0, total_votes: 0, yes_votes: 0, no_votes: 0 };
            const { data: voteCounts, error: votesError } = await supabase.rpc('get_vote_counts');
            if (votesError) {
                 if (votesError.code === '42883') console.warn("Funzione RPC get_vote_counts non trovata.");
                 else if (votesError.code === '42501') showMessage("Errore permessi RPC. Esegui SQL.", true);
                 else showMessage(`Errore DB conteggio: ${votesError.message}`, true);
                 console.error("Errore fetch counts:", votesError);
            } else { counts = voteCounts[0] || {}; }

            const totalPresenti = parseInt(counts.attendee_count) || 0;
            const totalVotanti = parseInt(counts.total_votes) || 0;
            const yesVotes = parseInt(counts.yes_votes) || 0;
            const noVotes = parseInt(counts.no_votes) || 0;
            const abstained = totalVotanti - (yesVotes + noVotes);

            // Verifica Registrazione e Voto utente (solo se non admin)
            if (!isAdminRole) {
                const { count: regCount } = await supabase.from('attendees').select('id', { count: 'exact', head: true }).eq('user_id', userId);
                isRegistered = (regCount !== null && regCount > 0);
                let checkVote = null;
                if (isRegistered) {
                    const { data: voteData } = await supabase.from('votes').select('created_at').eq('user_id', userId).order('created_at', { ascending: false }).limit(1).single();
                    checkVote = voteData;
                }
                if (settingsData && checkVote) {
                     const voteTimestamp = new Date(checkVote.created_at).getTime();
                     const resetTimestamp = settingsData.last_reset ? new Date(settingsData.last_reset).getTime() : 0;
                     hasVotedInCurrentRound = voteTimestamp > resetTimestamp;
                } else { hasVotedInCurrentRound = false; }
            }

            // Aggiorna stato globale
            // requiredCode = settingsData ? settingsData.required_code : null; // RIMOSSO
            isVotingActive = settingsData ? settingsData.is_voting_active : false;
            votingResults = { Favorevole: yesVotes, Contrario: noVotes, Astenuto: abstained < 0 ? 0 : abstained };

            // Aggiorna UI Admin
            if (isAdminRole && totalAttendeesEl) {
                totalAttendeesEl.textContent = totalPresenti;
                totalVotedEl.textContent = totalVotanti;
                const percent = totalPresenti > 0 ? Math.round((totalVotanti / totalPresenti) * 100) : 0;
                percentVotedEl.textContent = `${percent}%`;
                // currentRequiredCodeEl.textContent = requiredCode || 'N/A'; // RIMOSSO
                votingStatusTextEl.textContent = isVotingActive ? 'ATTIVO' : 'DISATTIVO';
                votingStatusTextEl.className = isVotingActive ? 'font-bold text-green-600' : 'font-bold text-red-600';
                toggleVotingBtn.textContent = isVotingActive ? 'Disattiva Votazione' : 'Attiva Votazione';
                toggleVotingBtn.className = isVotingActive ? 'w-full py-3 px-4 rounded-xl text-white font-semibold transition bg-green-600 hover:bg-green-700 shadow-md' : 'w-full py-3 px-4 rounded-xl text-white font-semibold transition bg-red-600 hover:bg-red-700 shadow-md';
            }
        } catch (e) { console.error("Errore fetch:", e); showMessage("Errore aggiornamento. Ricarica.", true); }
     }


    // --- FUNZIONI DI AZIONE ADMIN ---
    /* async function handleAdminCodeUpdate() { // FUNZIONE RIMOSSA
        // ...
    } */
    async function handleAdminToggle() { /* ... (come prima) ... */
        if (!initialised || !isAdminRole || !supabase) return; const newState = !isVotingActive;
        const { error } = await supabase.from('settings').update({ is_voting_active: newState }).eq('id', 1);
        if (error) {
            if (error.code === '42501') showMessage("Errore permessi UPDATE. Esegui SQL.", true);
            else showMessage("Errore cambio stato.", true);
            console.error("Errore toggle:", error);
        } else { isVotingActive = newState; showMessage(`Votazione ${newState ? 'ATTIVATA' : 'DISATTIVATA'}.`); renderApp(); }
     }
    async function handleResetResults() { /* ... (come prima, ma NON cancella attendees) ... */
        if (!initialised || !isAdminRole || !supabase) return;
        try {
            const { data: voteCounts, error: votesError } = await supabase.rpc('get_vote_counts');
            if (votesError) throw new Error(`Errore fetch counts: ${votesError.message}`);
            const counts = voteCounts[0] || {};
            const totalPresenti = parseInt(counts.attendee_count) || 0;
            const totalVotanti = parseInt(counts.total_votes) || 0;
            const yesVotes = parseInt(counts.yes_votes) || 0;
            const noVotes = parseInt(counts.no_votes) || 0;
            const abstained = totalVotanti - (yesVotes + noVotes);
            const { error: logError } = await supabase.from('log').insert({ attendee_count: totalPresenti, yes_votes: yesVotes, no_votes: noVotes, abstained_votes: abstained < 0 ? 0 : abstained });
            if (logError) throw new Error(`Errore log: ${logError.message}`);
            await supabase.from('votes').delete().neq('id', 0); // Cancella solo i voti
            const { error: updateError } = await supabase.from('settings').update({ last_reset: new Date().toISOString(), is_voting_active: false }).eq('id', 1);
            if (updateError) throw new Error(`Errore update timestamp: ${updateError.message}`);
            hasVotedInCurrentRound = false;
            showMessage(`Risultati salvati. Voti azzerati.`);
            renderApp();
        } catch (e) { console.error("Errore reset:", e); showMessage("ERRORE: Reset fallito.", true); }
     }
    async function handleResetProject() { /* ... (come prima, ma senza requiredCode) ... */
        if (!initialised || !isAdminRole || !supabase) return;
        if (!confirm('RESET TOTALE? Cancellerà TUTTI i dati!')) return;
        try {
            await supabase.from('votes').delete().neq('id', 0);
            await supabase.from('attendees').delete().neq('id', 0);
            await supabase.from('log').delete().neq('id', 0);
            await supabase.from('settings').update({ /* required_code: null, */ is_voting_active: false, last_reset: new Date().toISOString() }).eq('id', 1);
            // requiredCode = null; // RIMOSSO
            isVotingActive = false; isRegistered = false; hasVotedInCurrentRound = false;
            showMessage("RESET TOTALE ESEGUITO.");
            renderApp();
        } catch (e) { console.error("Errore reset totale:", e); showMessage("ERRORE: Reset totale fallito.", true); }
     }
    async function showDeliberationsLog() { /* ... (come prima) ... */
         if (!initialised || !isAdminRole || !supabase) return; isViewingLog = true; mainContentEl.innerHTML = '<p>Caricamento log...</p>';
         try {
             const { data, error } = await supabase.from('log').select('*').order('created_at', { ascending: false });
             if (error) throw new Error(error.message);
             let logHtml = data.length === 0 ? '<p>Nessun log salvato.</p>' : `<div class="log-list space-y-4">${data.map((row, index) => { const totalVoti = (row.yes_votes || 0) + (row.no_votes || 0) + (row.abstained_votes || 0); return `<div class="p-3 border rounded-lg bg-white"><p class="font-bold">Delibera #${data.length - index} - Voti: ${totalVoti} / Presenti: ${row.attendee_count || 'N/A'}</p><p class="text-xs text-gray-500">${formatTimestamp(row.created_at)}</p><div class="grid grid-cols-3 gap-1 text-xs"><span class="p-1 bg-green-100 text-green-700 rounded text-center">F: ${row.yes_votes || 0}</span><span class="p-1 bg-red-100 text-red-700 rounded text-center">C: ${row.no_votes || 0}</span><span class="p-1 bg-yellow-100 text-yellow-700 rounded text-center">A: ${row.abstained_votes || 0}</span></div></div>`; }).join('')}</div>`;
             mainContentEl.innerHTML = `<h2 class="text-2xl font-bold mb-4">Log Storico (${data.length})</h2>${logHtml}<button id="back-to-vote-btn" class="w-full mt-4 py-2 bg-blue-500 text-white rounded">Torna</button>`;
             const backBtn = document.getElementById('back-to-vote-btn');
             if(backBtn) backBtn.addEventListener('click', () => { isViewingLog = false; renderApp(); });
         } catch (e) { console.error("Errore log:", e); mainContentEl.innerHTML = '<p class="text-red-500">Errore caricamento log.</p>'; }
     }


    // --- FUNZIONI DI AZIONE UTENTE ---
    async function handleRegistration() { /* ... (come prima, ma senza codice) ... */
        if (!initialised || !supabase) return;
        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        // const codice = document.getElementById('codice').value.trim(); // RIMOSSO
        if (!nome || !cognome /* || !codice */) { showMessage("Compila Nome e Cognome.", true); return; }
        // if (requiredCode === null || requiredCode === 'null' || requiredCode === '') { showMessage("Codice accesso NON impostato.", true); return; } // RIMOSSO
        // if (codice != requiredCode) { showMessage("Codice univoco errato.", true); return; } // RIMOSSO
        try {
            const { count } = await supabase.from('attendees').select('id', { count: 'exact', head: true }).eq('user_id', userId);
            if (count !== null && count > 0) { isRegistered = true; showMessage("Già registrato/a."); renderApp(); return; }
            const { error } = await supabase.from('attendees').insert({ user_id: userId, first_name: nome, last_name: cognome /*, access_code: codice */ }); // RIMOSSO access_code
            if (error) throw new Error(error.message);
            isRegistered = true; showMessage(`Registrazione di ${nome} ${cognome} completata.`); renderApp();
        } catch (e) {
            console.error("Errore registrazione:", e);
            if (e.message.includes('permission denied')) showMessage("Errore permessi INSERT. Esegui SQL.", true);
            else showMessage("Errore salvataggio registrazione.", true);
        }
     }
    async function handleVote(choice) { /* ... (come prima) ... */
        if (!initialised || !supabase) return;
        if (!isVotingActive) { showMessage("Votazione disattivata.", true); return; }
        if (hasVotedInCurrentRound) { showMessage("Hai già votato.", true); return; }
        let voteValue = (choice === 'Favorevole'); let voteText = choice;
        try {
            const { error } = await supabase.from('votes').insert({ user_id: userId, vote: voteValue, vote_text: voteText });
            if (error) throw new Error(error.message);
            hasVotedInCurrentRound = true; showMessage(`Voto espresso: ${choice}.`); renderApp();
        } catch (e) {
            console.error("Errore votazione:", e);
            if (e.message.includes('permission denied')) showMessage("Errore permessi INSERT. Esegui SQL.", true);
            else showMessage("Errore invio voto.", true);
        }
     }


    // --- RENDERING DELL'APPLICAZIONE ---
    function renderApp() { /* ... (come prima) ... */
         if (!initialised) return; if (isViewingLog) return;
         if (isAdminRole) renderAdminDashboard(); else renderUserInterface();
         if (typeof lucide !== 'undefined' && typeof lucide.createIcons === 'function') { try { lucide.createIcons(); } catch (e) { console.warn("Errore icone Lucide:", e); } }
         else console.warn("Lucide non pronto.");
     }
    function renderAdminDashboard() { /* ... (come prima) ... */
         if (!adminPanelEl) return; adminPanelEl.classList.remove('hidden'); if (isViewingLog) return;
         mainContentEl.innerHTML = `<h2 class="text-2xl font-bold mb-6 text-center"><span class="text-red-600">Risultati Tempo Reale</span></h2><div class="grid grid-cols-3 gap-2 text-center mb-4"><div class="p-3 bg-green-50 rounded"><p class="text-3xl font-bold text-green-600">${votingResults.Favorevole}</p><p class="text-sm text-green-700">Favorevoli</p></div><div class="p-3 bg-red-50 rounded"><p class="text-3xl font-bold text-red-600">${votingResults.Contrario}</p><p class="text-sm text-red-700">Contrari</p></div><div class="p-3 bg-yellow-50 rounded"><p class="text-3xl font-bold text-yellow-600">${votingResults.Astenuto}</p><p class="text-sm text-yellow-700">Astenuti</p></div></div><p class="text-center text-sm text-gray-600 mt-4">Aggiornati ogni secondo.</p>`;
     }
    function renderUserInterface() { /* ... (come prima) ... */
         if (!isRegistered) renderRegistrationPage(); else renderVotingPage();
     }
    function renderRegistrationPage() { /* ... (come prima, ma senza codice input/status) ... */
        const savedNome = document.getElementById('nome')?.value || '';
        const savedCognome = document.getElementById('cognome')?.value || '';
        // const savedCodice = document.getElementById('codice')?.value || ''; // RIMOSSO
        // const codeValid = requiredCode !== null && requiredCode !== 'null' && requiredCode !== ''; // RIMOSSO
        // const codeStatus = codeValid ? '<p>Codice ATTIVO.</p>' : '<p class="text-red-600">Codice NON impostato.</p>'; // RIMOSSO
        const isButtonDisabled = isRegistered; // Disabilitato solo se già registrato

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-bold mb-6 text-center"><span class="text-blue-600">Registro</span> Presenze</h2>
            <div class="p-3 mb-4 bg-gray-50 border rounded"><p class="text-sm text-center">ID Utente: <span class="font-mono text-xs bg-gray-200 p-1 rounded">${userId || '...'}</span></p></div>
            ${isRegistered ? '<p class="text-lg text-green-600 font-bold text-center mb-4">Presenza Registrata.</p>' : '' }
            <div class="space-y-4">
                <input type="text" id="nome" placeholder="Nome" class="w-full p-3 border rounded focus:ring-blue-500" value="${savedNome}" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="cognome" placeholder="Cognome" class="w-full p-3 border rounded focus:ring-blue-500" value="${savedCognome}" ${isRegistered ? 'disabled' : ''}/>
                <!-- <input type="text" id="codice" placeholder="Codice Univoco" class="w-full p-3 border rounded" value="${savedCodice}" ${isRegistered ? 'disabled' : ''}/> --> <!-- RIMOSSO -->
                <button id="register-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700 shadow ${isButtonDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${isButtonDisabled ? 'disabled' : ''}>
                    Registra Presenza
                </button>
            </div>`;
        const regBtn = document.getElementById('register-btn');
        if (regBtn && !isButtonDisabled) {
             regBtn.replaceWith(regBtn.cloneNode(true));
             document.getElementById('register-btn').addEventListener('click', handleRegistration);
        }
     }
    function renderVotingPage() { /* ... (come prima) ... */
         const statusClass = isVotingActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
         const statusText = isVotingActive ? 'Votazione Attiva: Esprimi il tuo voto.' : 'Votazione Chiusa.';
         const isDisabled = !isVotingActive || hasVotedInCurrentRound;
         const disabledClass = isDisabled ? 'opacity-50 cursor-not-allowed' : '';
         const votedClass = hasVotedInCurrentRound ? 'bg-blue-800 text-white' : '';
         let voteMessage = hasVotedInCurrentRound ? '<p class="text-center text-sm text-blue-700 p-2 bg-blue-50 rounded font-bold">Voto Registrato.</p>' : '';

         mainContentEl.innerHTML = `
             <h2 class="text-2xl font-bold mb-6 text-center"><span class="text-blue-600">Esprimi</span> il Voto</h2>
             <div class="p-4 rounded mb-6 font-semibold text-center ${statusClass}">${statusText}</div>
             ${voteMessage}
             <div class="grid grid-cols-1 gap-4">
                 <button data-vote="Favorevole" ${isDisabled ? 'disabled' : ''} class="vote-btn py-5 px-4 rounded text-white font-bold bg-green-600 hover:bg-green-700 ${disabledClass} ${votedClass} shadow"> Favorevole </button>
                 <button data-vote="Contrario/a" ${isDisabled ? 'disabled' : ''} class="vote-btn py-5 px-4 rounded text-white font-bold bg-red-600 hover:bg-red-700 ${disabledClass} ${votedClass} shadow"> Contrario/a </button>
                 <button data-vote="Astenuto/a" ${isDisabled ? 'disabled' : ''} class="vote-btn py-5 px-4 rounded text-gray-800 font-bold bg-yellow-400 hover:bg-yellow-500 ${disabledClass} ${votedClass} shadow"> Astenuto/a </button>
             </div>`;
         mainContentEl.querySelectorAll('.vote-btn').forEach(button => {
             if (!isDisabled) {
                  button.replaceWith(button.cloneNode(true));
                  mainContentEl.querySelector(`[data-vote="${button.dataset.vote}"]`).addEventListener('click', (e) => handleVote(e.currentTarget.dataset.vote));
             }
         });
     }


    // --- INIZIALIZZAZIONE ---
    function initApp() { /* ... (come prima, aggiornato per i riferimenti rimossi) ... */
        if (!initialised) {
            try {
                // Non procedere se Supabase non è caricato
                if (typeof window.supabase !== 'object' || typeof window.supabase.createClient !== 'function') {
                    // Ritenta l'inizializzazione dopo un breve ritardo
                    console.warn("Supabase non ancora pronto, ritento...");
                    setTimeout(initApp, 200); // Ritenta dopo 200ms
                    return;
                }
                initializeSupabase();
            } catch (e) { return; } // Errore già gestito
            if (!initialised) return;

            userId = getUserId();
            isAdminRole = getUrlParameter('role') === 'admin';

            if (isAdminRole && adminPanelEl) {
                totalAttendeesEl = document.getElementById('total-attendees');
                totalVotedEl = document.getElementById('total-voted');
                percentVotedEl = document.getElementById('percent-voted');
                toggleVotingBtn = document.getElementById('toggle-voting-btn');
                resetResultsBtn = document.getElementById('reset-results-btn');
                // updateCodeBtn = document.getElementById('update-code-btn'); // RIMOSSO
                votingStatusTextEl = document.getElementById('voting-status-text');
                // currentRequiredCodeEl = document.getElementById('current-required-code'); // RIMOSSO
                showDeliberationsBtn = document.getElementById('show-deliberations-btn');
                resetProjectBtn = document.getElementById('reset-project-btn');
                adminPanelEl.classList.remove('hidden');

                // Aggiunge listener Admin (senza updateCodeBtn)
                // if (updateCodeBtn) { updateCodeBtn.replaceWith(updateCodeBtn.cloneNode(true)); document.getElementById('update-code-btn').addEventListener('click', handleAdminCodeUpdate); } // RIMOSSO
                if (toggleVotingBtn) { toggleVotingBtn.replaceWith(toggleVotingBtn.cloneNode(true)); document.getElementById('toggle-voting-btn').addEventListener('click', handleAdminToggle); }
                if (resetResultsBtn) { resetResultsBtn.replaceWith(resetResultsBtn.cloneNode(true)); document.getElementById('reset-results-btn').addEventListener('click', handleResetResults); }
                if (showDeliberationsBtn) { showDeliberationsBtn.replaceWith(showDeliberationsBtn.cloneNode(true)); document.getElementById('show-deliberations-btn').addEventListener('click', showDeliberationsLog); }
                if (resetProjectBtn) { resetProjectBtn.replaceWith(resetProjectBtn.cloneNode(true)); document.getElementById('reset-project-btn').addEventListener('click', handleResetProject); }

            } else if (adminPanelEl) {
                adminPanelEl.remove();
            }

            if (initialised) {
                startPollingLoop();
                fetchSettingsAndVotes().then(renderApp);
            }
        }
     }
    function startPollingLoop() { /* ... (come prima) ... */
         setInterval(async () => {
             if (!initialised || isViewingLog) return;
             await fetchSettingsAndVotes();
             const activeElement = document.activeElement;
             const isTyping = activeElement && (activeElement.tagName === 'INPUT');
             if (!isTyping) renderApp();
         }, 1000);
     }

    // Punto di ingresso gestito dalla promessa nell'HEAD
</script>
</body>
</html>

