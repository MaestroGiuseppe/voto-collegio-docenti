<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voto Collegio Docenti</title>
    <!-- Carica Tailwind CSS (per lo styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carica Lucide Icons (per le icone) -->
    <script type="module">
        import { createIcons, CheckCircle, XCircle, Users, Lock, Unlock, Zap, TrendingUp, TrendingDown, RefreshCw, LogIn, LogOut, Code, Settings } from 'https://cdn.jsdelivr.net/npm/lucide-esm@latest/dist/lucide-esm.js';
        document.addEventListener('DOMContentLoaded', () => {
            createIcons({ icons: { CheckCircle, XCircle, Users, Lock, Unlock, Zap, TrendingUp, TrendingDown, RefreshCw, LogIn, LogOut, Code, Settings } });
        });
    </script>
    <style>
        /* Imposta il font Inter come predefinito */
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        /* Stile di base per il contenitore dell'app */
        .app-container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        /* Stili per le schede di voto */
        .vote-card {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            @apply shadow-lg hover:shadow-xl;
        }
        .vote-card:hover { transform: translateY(-3px); }
        .vote-card.voted { border: 4px solid #3b82f6; }
        .pulse-active { animation: pulse-active 1.5s infinite; }
        @keyframes pulse-active {
            0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
        }
        .text-shadow { text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2); }
        /* Stile per i messaggi di stato */
        #status-message {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #status-message.show { opacity: 1; }
        /* Stile per l'area amministrativa (nascondi per default) */
        #admin-area { display: none; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="status-message" class="p-3 rounded-xl shadow-2xl text-white bg-green-600"></div>

    <header class="bg-blue-600 text-white shadow-xl">
        <div class="app-container py-4 flex flex-col md:flex-row justify-between items-center">
            <h1 class="text-3xl font-bold tracking-tight text-shadow">
                Voto Collegio Docenti
            </h1>
            <div id="auth-status" class="mt-2 md:mt-0 text-sm flex items-center space-x-2">
                <span id="user-info" class="font-medium"></span>
                <button onclick="handleLogout()" id="logout-button" class="bg-blue-700 hover:bg-blue-800 p-2 rounded-full transition duration-150 transform hover:scale-105" title="Esci">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="app-container mt-8">

        <!-- Area di Voto Pubblica -->
        <section id="voting-area" class="bg-white p-6 md:p-10 rounded-3xl shadow-2xl border border-gray-100">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Esprimi il tuo Voto</h2>

            <!-- Stato Votazione -->
            <div id="voting-status-display" class="mb-8 p-4 rounded-xl text-center shadow-inner">
                <p id="voting-message" class="text-xl font-semibold"></p>
                <div id="code-prompt" class="mt-4 hidden">
                    <p class="text-sm text-gray-600 mb-2">Inserisci il tuo codice di accesso per registrarti:</p>
                    <div class="flex justify-center space-x-2">
                        <input type="text" id="access-code" placeholder="Codice" class="p-3 border border-gray-300 rounded-xl w-32 focus:ring-blue-500 focus:border-blue-500 text-center">
                        <button onclick="handleLogin()" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition duration-150">
                            <i data-lucide="log-in" class="w-5 h-5 inline-block mr-1"></i>Accedi
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard di Voto -->
            <div id="vote-dashboard" class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-10">

                <!-- Scheda Voto Favorevole -->
                <div id="card-favorevole" onclick="handleVote('Favorevole')" class="vote-card p-6 flex flex-col items-center justify-center bg-green-50 border-4 border-green-200 rounded-3xl">
                    <i data-lucide="check-circle" class="w-16 h-16 text-green-600 mb-4"></i>
                    <h3 class="text-3xl font-bold text-green-800">Favorevole</h3>
                </div>

                <!-- Scheda Voto Contrario -->
                <div id="card-contrario" onclick="handleVote('Contrario')" class="vote-card p-6 flex flex-col items-center justify-center bg-red-50 border-4 border-red-200 rounded-3xl">
                    <i data-lucide="x-circle" class="w-16 h-16 text-red-600 mb-4"></i>
                    <h3 class="text-3xl font-bold text-red-800">Contrario</h3>
                </div>
            </div>

            <!-- Messaggio di Voto Effettuato -->
            <div id="voted-message" class="mt-8 text-center hidden">
                <p class="text-2xl font-semibold text-blue-600 flex items-center justify-center">
                    <i data-lucide="check-circle" class="w-6 h-6 mr-2"></i> Il tuo voto Ã¨ stato registrato.
                </p>
            </div>
            
            <!-- Pulsante di aggiornamento -->
            <div class="mt-8 text-center">
                 <button onclick="fetchSettingsAndVotes(true)" class="bg-gray-200 text-gray-700 p-3 rounded-xl hover:bg-gray-300 transition duration-150">
                    <i data-lucide="refresh-cw" class="w-5 h-5 inline-block mr-1"></i> Aggiorna Risultati
                </button>
            </div>
        </section>

        <!-- Area Risultati in Tempo Reale -->
        <section id="results-area" class="mt-12 bg-white p-6 md:p-10 rounded-3xl shadow-2xl border border-gray-100">
            <h2 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">Risultati in Tempo Reale</h2>
            
            <div id="results-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                
                <!-- Totale Docenti -->
                <div class="p-6 bg-blue-50 rounded-xl shadow-md border border-blue-200">
                    <i data-lucide="users" class="w-8 h-8 text-blue-600 mx-auto mb-2"></i>
                    <p class="text-sm font-medium text-blue-700">Docenti Registrati</p>
                    <p id="attendee-count" class="text-4xl font-extrabold text-blue-800">0</p>
                </div>
                
                <!-- Totale Voti -->
                <div class="p-6 bg-gray-50 rounded-xl shadow-md border border-gray-200">
                    <i data-lucide="zap" class="w-8 h-8 text-gray-600 mx-auto mb-2"></i>
                    <p class="text-sm font-medium text-gray-700">Voti Totali</p>
                    <p id="total-votes" class="text-4xl font-extrabold text-gray-800">0</p>
                </div>
                
                <!-- Percentuale -->
                <div class="p-6 bg-yellow-50 rounded-xl shadow-md border border-yellow-200">
                    <i data-lucide="trending-up" class="w-8 h-8 text-yellow-600 mx-auto mb-2"></i>
                    <p class="text-sm font-medium text-yellow-700">Percentuale Votanti</p>
                    <p id="voting-percentage" class="text-4xl font-extrabold text-yellow-800">0%</p>
                </div>
                
                <!-- Voti Favorevoli -->
                <div class="col-span-1 md:col-span-3 p-6 bg-green-50 rounded-xl shadow-md border border-green-200">
                    <i data-lucide="trending-up" class="w-8 h-8 text-green-600 mx-auto mb-2"></i>
                    <p class="text-sm font-medium text-green-700">Voti Favorevoli</p>
                    <p id="yes-votes" class="text-4xl font-extrabold text-green-800">0</p>
                    <div id="yes-bar" class="h-4 mt-2 rounded-full bg-green-400 transition-all duration-500" style="width: 0%;"></div>
                </div>
                
                <!-- Voti Contrari -->
                <div class="col-span-1 md:col-span-3 p-6 bg-red-50 rounded-xl shadow-md border border-red-200">
                    <i data-lucide="trending-down" class="w-8 h-8 text-red-600 mx-auto mb-2"></i>
                    <p class="text-sm font-medium text-red-700">Voti Contrari</p>
                    <p id="no-votes" class="text-4xl font-extrabold text-red-800">0</p>
                    <div id="no-bar" class="h-4 mt-2 rounded-full bg-red-400 transition-all duration-500" style="width: 0%;"></div>
                </div>
            </div>
        </section>

        <!-- Area Amministrativa (Nascosta) -->
        <section id="admin-area" class="mt-12 bg-gray-900 text-white p-6 md:p-10 rounded-3xl shadow-2xl pulse-active">
            <h2 class="text-3xl font-extrabold mb-6 text-center">Pannello Amministratore</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Gestione Stato Votazione -->
                <div class="p-6 bg-gray-800 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i data-lucide="settings" class="w-5 h-5 mr-2 text-yellow-400"></i> Gestione Stato Voto
                    </h3>
                    <p id="admin-current-status" class="mb-4 text-lg font-medium text-blue-400"></p>
                    <div class="flex space-x-4">
                        <button onclick="updateVotingStatus(true)" id="btn-start-vote" class="w-full bg-green-600 text-white p-3 rounded-xl hover:bg-green-700 transition duration-150 flex items-center justify-center">
                            <i data-lucide="unlock" class="w-5 h-5 mr-2"></i> Avvia Voto
                        </button>
                        <button onclick="updateVotingStatus(false)" id="btn-stop-vote" class="w-full bg-red-600 text-white p-3 rounded-xl hover:bg-red-700 transition duration-150 flex items-center justify-center">
                            <i data-lucide="lock" class="w-5 h-5 mr-2"></i> Ferma Voto
                        </button>
                    </div>
                </div>
                
                <!-- Gestione Codice -->
                <div class="p-6 bg-gray-800 rounded-xl shadow-xl">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <i data-lucide="code" class="w-5 h-5 mr-2 text-yellow-400"></i> Codice di Accesso
                    </h3>
                    <p id="admin-current-code" class="mb-4 text-lg font-medium text-blue-400"></p>
                    <div class="flex space-x-2">
                        <input type="text" id="new-code-input" placeholder="Nuovo Codice (es. 1234)" class="p-3 border border-gray-600 rounded-xl w-full text-gray-900" maxlength="10">
                        <button onclick="updateSettingsCode()" class="bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition duration-150">
                            Salva
                        </button>
                    </div>
                    <button onclick="resetSystem()" class="w-full mt-4 bg-yellow-600 text-white p-3 rounded-xl hover:bg-yellow-700 transition duration-150">
                        Reset Totale Database (â ï¸ Pericolo)
                    </button>
                </div>
            </div>
        </section>

    </main>

    <footer class="app-container text-center text-gray-500 text-sm py-8 mt-12">
        <p>&copy; 2025 Voto Collegio Docenti. Realizzato con Supabase e JavaScript.</p>
    </footer>

    <!-- Script di Logica -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/index.browser.js';

        // =========================================================================
        // CONFIGURAZIONE SUPABASE - AGGIORNARE QUI CON LE NUOVE CREDENZIALI
        // =========================================================================
        const SUPABASE_URL = 'https://iuuvakwbuequapwoyddd.supabase.co';
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dXZha3didWVxdWFwd295ZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTE5ODEsImV4cCI6MjA3Njg4Nzk4MX0.c7BpXAk8hF0lijNnWaURjQxsZDBv66JvV8NJ1xxX-KI';

        // Pulizia per prevenire errori di spazio bianco (giÃ  implementata)
        const supabase = createClient(
            SUPABASE_URL.trim(),
            SUPABASE_API_KEY.trim(),
            {
                auth: {
                    persistSession: false,
                }
            }
        );

        let userId = null; // ID dell'utente attualmente loggato (docente)
        let isAdmin = false; // Flag per l'accesso amministratore
        let userVoted = false; // Flag per tracciare il voto dell'utente
        let votingIsActive = false; // Stato globale della votazione
        let requiredCode = null; // Codice richiesto per l'accesso

        console.log('Supabase Client inizializzato con successo.');

        // =========================================================================
        // UI FUNCTIONS
        // =========================================================================

        /**
         * Mostra un messaggio di stato (es. successo o errore)
         * @param {string} message - Il messaggio da mostrare.
         * @param {string} type - Il tipo ('success' o 'error').
         */
        function showStatusMessage(message, type = 'success') {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.className = 'p-3 rounded-xl shadow-2xl text-white';

            if (type === 'error') {
                statusDiv.classList.add('bg-red-600');
            } else {
                statusDiv.classList.add('bg-green-600');
            }

            statusDiv.classList.add('show');
            setTimeout(() => {
                statusDiv.classList.remove('show');
            }, 3000);
        }

        /**
         * Aggiorna lo stato della votazione e l'interfaccia.
         */
        function updateVotingUI() {
            const messageDiv = document.getElementById('voting-message');
            const codePrompt = document.getElementById('code-prompt');
            const voteDashboard = document.getElementById('vote-dashboard');
            const votedMessage = document.getElementById('voted-message');
            const cardFavorevole = document.getElementById('card-favorevole');
            const cardContrario = document.getElementById('card-contrario');
            const adminArea = document.getElementById('admin-area');

            // 1. Stato Login/Admin
            if (userId) {
                document.getElementById('user-info').textContent = isAdmin ? 'Amministratore' : `Docente ID: ${userId.substring(0, 8)}...`;
                document.getElementById('logout-button').style.display = 'block';
            } else {
                document.getElementById('user-info').textContent = 'Non Acceduto';
                document.getElementById('logout-button').style.display = 'none';
            }

            // Mostra/nascondi area Admin
            adminArea.style.display = isAdmin ? 'block' : 'none';
            if (isAdmin) {
                document.getElementById('admin-current-status').textContent = `Stato Attuale: ${votingIsActive ? 'Voto APERTO' : 'Voto CHIUSO'}`;
                document.getElementById('admin-current-code').textContent = `Codice Attuale: ${requiredCode || 'Nessun Codice (Accesso Libero)'}`;
                document.getElementById('btn-start-vote').disabled = votingIsActive;
                document.getElementById('btn-stop-vote').disabled = !votingIsActive;
            }

            // 2. Stato Voto
            if (votingIsActive) {
                // Voto Attivo
                messageDiv.textContent = 'La votazione Ã¨ attualmente APERTA. Effettua la tua scelta.';
                messageDiv.classList.remove('text-red-600');
                messageDiv.classList.add('text-green-600');

                if (userId) {
                    codePrompt.classList.add('hidden'); // Nascondi prompt se loggato

                    if (userVoted) {
                        voteDashboard.classList.add('pointer-events-none', 'opacity-50');
                        votedMessage.classList.remove('hidden');
                        cardFavorevole.classList.remove('voted');
                        cardContrario.classList.remove('voted');
                    } else {
                        voteDashboard.classList.remove('pointer-events-none', 'opacity-50');
                        votedMessage.classList.add('hidden');
                    }

                } else {
                    // Non loggato, mostra prompt se codice richiesto
                    if (requiredCode) {
                         messageDiv.textContent = 'Inserisci il codice di accesso per votare.';
                         messageDiv.classList.add('text-blue-600');
                         codePrompt.classList.remove('hidden');
                         voteDashboard.classList.add('pointer-events-none', 'opacity-50');
                    } else {
                         // Nessun codice richiesto, permetti login anonimo e voto
                         codePrompt.classList.add('hidden');
                         voteDashboard.classList.remove('pointer-events-none', 'opacity-50');
                         handleLogin(); // Accesso automatico anonimo
                    }
                }

            } else {
                // Voto Chiuso
                messageDiv.textContent = 'La votazione Ã¨ attualmente CHIUSA. Attendi l\'avvio.';
                messageDiv.classList.remove('text-green-600');
                messageDiv.classList.add('text-red-600');
                codePrompt.classList.add('hidden');
                voteDashboard.classList.add('pointer-events-none', 'opacity-50');
                votedMessage.classList.add('hidden');
            }
        }

        /**
         * Aggiorna la dashboard dei risultati.
         * @param {object} counts - L'oggetto con i conteggi dei voti.
         */
        function updateResultsUI(counts) {
            const attendeeCount = counts.attendee_count || 0;
            const totalVotes = counts.total_votes || 0;
            const yesVotes = counts.yes_votes || 0;
            const noVotes = counts.no_votes || 0;

            document.getElementById('attendee-count').textContent = attendeeCount;
            document.getElementById('total-votes').textContent = totalVotes;
            document.getElementById('yes-votes').textContent = yesVotes;
            document.getElementById('no-votes').textContent = noVotes;

            let percentage = 0;
            if (attendeeCount > 0) {
                percentage = Math.round((totalVotes / attendeeCount) * 100);
            }
            document.getElementById('voting-percentage').textContent = `${percentage}%`;

            // Aggiorna le barre di progresso
            let totalVoters = yesVotes + noVotes;
            if (totalVoters === 0) {
                totalVoters = 1; // Previene divisione per zero
            }

            const yesWidth = Math.round((yesVotes / totalVoters) * 100);
            const noWidth = Math.round((noVotes / totalVoters) * 100);

            document.getElementById('yes-bar').style.width = `${yesWidth}%`;
            document.getElementById('no-bar').style.width = `${noWidth}%`;
        }

        // =========================================================================
        // AUTHENTICATION & SESSION
        // =========================================================================

        /**
         * Gestisce il login (Admin o Docente)
         */
        async function handleLogin() {
            const accessCode = document.getElementById('access-code').value.trim();
            const isAdminCode = accessCode === 'admin';

            // 1. LOGIN ADMIN
            if (isAdminCode && requiredCode) {
                showStatusMessage('L\'accesso admin non Ã¨ consentito con codice richiesto.', 'error');
                return;
            }
            
            if (isAdminCode && !requiredCode) {
                userId = 'admin_user'; // ID fittizio per admin
                isAdmin = true;
                updateVotingUI();
                showStatusMessage('Accesso Admin effettuato.', 'success');
                return;
            }

            // 2. LOGIN DOCENTE (con codice o anonimo)
            if (requiredCode && accessCode !== requiredCode) {
                showStatusMessage('Codice di accesso non valido.', 'error');
                return;
            }

            // Login anonimo (o con codice corretto)
            try {
                // Genera un ID utente unico per la sessione (o usa un cookie/storage)
                userId = window.crypto.randomUUID();

                // Registra l'utente se non Ã¨ giÃ  presente
                const { data: existingAttendee } = await supabase
                    .from('attendees')
                    .select('id')
                    .eq('session_id', userId)
                    .single();

                if (!existingAttendee) {
                    const { error: insertError } = await supabase
                        .from('attendees')
                        .insert([{ session_id: userId }]);

                    if (insertError) {
                        throw insertError;
                    }
                }
                
                // Controlla se l'utente ha giÃ  votato
                await checkUserVoteStatus();

                isAdmin = false;
                updateVotingUI();
                showStatusMessage(`Accesso Docente riuscito!`, 'success');

            } catch (error) {
                console.error('Errore durante l\'accesso o la registrazione:', error);
                showStatusMessage('Errore di accesso. Riprova.', 'error');
            }
        }

        /**
         * Gestisce il logout dell'utente (o dell'admin)
         */
        function handleLogout() {
            userId = null;
            isAdmin = false;
            userVoted = false;
            document.getElementById('access-code').value = '';
            document.getElementById('user-info').textContent = 'Disconnesso';
            updateVotingUI();
            showStatusMessage('Disconnessione effettuata.', 'success');
        }

        // =========================================================================
        // DATABASE READ (Impostazioni e Voti)
        // =========================================================================

        /**
         * Fetches settings, vote counts, and checks the user's vote status.
         */
        async function fetchSettingsAndVotes(refresh = false) {
            try {
                // 1. Fetch Impostazioni
                const { data: settingsData, error: settingsError } = await supabase
                    .from('settings')
                    .select('is_voting_active, required_code, id')
                    .limit(1)
                    .single();

                if (settingsError && settingsError.code !== 'PGRST116') { // PGRST116 = nessun risultato trovato
                    throw settingsError;
                }

                if (settingsData) {
                    votingIsActive = settingsData.is_voting_active;
                    requiredCode = settingsData.required_code;
                } else {
                    // Imposta valori predefiniti se la tabella Ã¨ vuota
                    votingIsActive = false;
                    requiredCode = null;
                }
                
                // 2. Fetch Conteggi Voti tramite funzione SQL
                const { data: counts, error: countsError } = await supabase.rpc('get_vote_counts');

                if (countsError) {
                    console.error("Errore RPC get_vote_counts:", countsError);
                    showStatusMessage('Errore nel recupero dei risultati.', 'error');
                    return;
                }

                // 3. Controlla lo stato del voto dell'utente loggato
                if (userId && !isAdmin && !refresh) {
                   await checkUserVoteStatus();
                }
                
                // Aggiorna l'interfaccia
                updateResultsUI(counts[0] || {});
                updateVotingUI();

            } catch (error) {
                console.error('Errore fetch settings o vote counts:', error);
                showStatusMessage('Errore durante l\'inizializzazione dell\'app.', 'error');
            }
        }

        /**
         * Controlla se l'utente attuale ha giÃ  votato.
         */
        async function checkUserVoteStatus() {
            if (!userId) {
                userVoted = false;
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('votes')
                    .select('id')
                    .eq('session_id', userId)
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 = nessun risultato trovato
                    throw error;
                }

                userVoted = !!data;

            } catch (error) {
                console.error('Errore nel controllo stato voto:', error);
                showStatusMessage('Errore nel controllo stato voto.', 'error');
            }
        }

        // =========================================================================
        // DATABASE WRITE (Voto)
        // =========================================================================

        /**
         * Registra il voto dell'utente.
         * @param {string} voteType - 'Favorevole' o 'Contrario'.
         */
        async function handleVote(voteType) {
            if (!votingIsActive) {
                showStatusMessage('La votazione Ã¨ chiusa.', 'error');
                return;
            }
            if (!userId || isAdmin) {
                 showStatusMessage('Devi prima effettuare l\'accesso come docente per votare.', 'error');
                 return;
            }
            if (userVoted) {
                showStatusMessage('Hai giÃ  espresso il tuo voto.', 'error');
                return;
            }

            try {
                // Registra il voto
                const { error } = await supabase
                    .from('votes')
                    .insert([
                        { session_id: userId, vote: voteType }
                    ]);

                if (error) {
                    // Controlla per vincolo di unicitÃ  (giÃ  votato)
                    if (error.code === '23505') {
                        showStatusMessage('Hai giÃ  espresso il tuo voto.', 'error');
                    } else {
                        throw error;
                    }
                } else {
                    userVoted = true;
                    updateVotingUI();
                    showStatusMessage('Voto registrato con successo!', 'success');
                    
                    // Logga l'azione
                    await supabase.from('log').insert([{ message: `Voto registrato: ${voteType} da ${userId.substring(0, 8)}...` }]);
                }

            } catch (error) {
                console.error('Errore durante la registrazione del voto:', error);
                showStatusMessage('Errore durante la registrazione del voto.', 'error');
            }
        }

        // =========================================================================
        // ADMIN FUNCTIONS
        // =========================================================================

        /**
         * Aggiorna lo stato di attivazione/disattivazione della votazione.
         * @param {boolean} isActive - True per aprire, False per chiudere.
         */
        async function updateVotingStatus(isActive) {
            if (!isAdmin) return;

            try {
                // Chiama la funzione RPC per aggiornare lo stato
                const { error } = await supabase.rpc('update_admin_settings', {
                    new_code: requiredCode,
                    is_voting_active: isActive
                });

                if (error) throw error;

                votingIsActive = isActive;
                updateVotingUI();
                showStatusMessage(`Votazione ${isActive ? 'APERTURA' : 'CHIUSURA'} eseguita con successo!`, 'success');
                
                // Logga l'azione
                await supabase.from('log').insert([{ message: `Admin ha ${isActive ? 'APERTURA' : 'CHIUSURA'} la votazione.` }]);

            } catch (error) {
                console.error('Errore durante l\'aggiornamento dello stato:', error);
                showStatusMessage('Errore aggiornamento stato votazione.', 'error');
            }
        }

        /**
         * Aggiorna il codice di accesso richiesto.
         */
        async function updateSettingsCode() {
            if (!isAdmin) return;

            const newCode = document.getElementById('new-code-input').value.trim();
            const codeToSave = newCode === '' ? null : newCode;

            try {
                // Chiama la funzione RPC per aggiornare il codice
                const { error } = await supabase.rpc('update_admin_settings', {
                    new_code: codeToSave,
                    is_voting_active: votingIsActive
                });

                if (error) throw error;

                requiredCode = codeToSave;
                updateVotingUI();
                showStatusMessage('Codice di accesso aggiornato con successo!', 'success');
                
                // Logga l'azione
                await supabase.from('log').insert([{ message: `Admin ha aggiornato il codice di accesso.` }]);

            } catch (error) {
                console.error('Errore durante l\'aggiornamento del codice:', error);
                showStatusMessage('Errore aggiornamento codice.', 'error');
            }
        }

        /**
         * Reset Totale del Sistema (Elimina voti e partecipanti)
         */
        async function resetSystem() {
            if (!isAdmin || !confirm('Sei sicuro di voler effettuare un RESET TOTALE? Verranno eliminati tutti i Voti e i Partecipanti.')) {
                return;
            }
            try {
                // Elimina tutti i voti
                const { error: voteError } = await supabase.from('votes').delete().neq('id', 0);
                if (voteError) throw voteError;

                // Elimina tutti i partecipanti
                const { error: attendeeError } = await supabase.from('attendees').delete().neq('id', 0);
                if (attendeeError) throw attendeeError;
                
                // Pulisci il log
                await supabase.from('log').delete().neq('id', 0);

                // Resetta le impostazioni di voto a CHIUSO e nessun codice
                const { error: settingsError } = await supabase.rpc('update_admin_settings', {
                    new_code: null,
                    is_voting_active: false
                });
                if (settingsError) throw settingsError;

                // Aggiorna la UI
                handleLogout(); // Disconnette tutti, incluso l'admin
                showStatusMessage('RESET TOTALE ESEGUITO con successo. Il sistema Ã¨ pronto per un nuovo voto.', 'success');
                fetchSettingsAndVotes(); // Ricarica lo stato
                
            } catch (error) {
                 console.error('Errore durante il reset totale:', error);
                 showStatusMessage('Errore critico durante il reset totale del sistema.', 'error');
            }
        }

        // =========================================================================
        // REALTIME SUBSCRIPTION & INIT
        // =========================================================================

        /**
         * Avvia la sottoscrizione Realtime per gli aggiornamenti.
         */
        function setupRealtime() {
            supabase
                .channel('public:votes, settings')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, (payload) => {
                    console.log('Realtime change: votes', payload);
                    fetchSettingsAndVotes();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'attendees' }, (payload) => {
                    console.log('Realtime change: attendees', payload);
                    fetchSettingsAndVotes();
                })
                .on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, (payload) => {
                    console.log('Realtime change: settings', payload);
                    fetchSettingsAndVotes();
                })
                .subscribe();

            console.log('Supabase Realtime Abilitato.');
        }

        // Inizializzazione: chiamata alla prima lettura dei dati e avvio Realtime
        window.onload = function() {
            // Rende le funzioni globali disponibili per gli handler onclick nell'HTML
            window.handleLogin = handleLogin;
            window.handleLogout = handleLogout;
            window.handleVote = handleVote;
            window.updateVotingStatus = updateVotingStatus;
            window.updateSettingsCode = updateSettingsCode;
            window.resetSystem = resetSystem;
            window.fetchSettingsAndVotes = fetchSettingsAndVotes;

            fetchSettingsAndVotes();
            setupRealtime();
        };

    </script>
</body>
</html>
