<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti</title>
    
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Libreria Supabase Client (CORRETTA) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    
    <!-- Libreria Lucide Icons (CORRETTA) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Stile personalizzato per il corpo e i pulsanti */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
            width: 95%;
            margin-bottom: 1.5rem; 
        }
        .vote-btn {
            transition: all 0.2s;
            transform: scale(1.0);
        }
        .vote-btn:hover:not(.opacity-50) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .vote-btn:active:not(.opacity-50) {
            transform: scale(0.98);
        }
        .log-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
    <!-- Configurazione del Font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
        // Inizializza Lucide icons
        window.onload = function() {
            lucide.createIcons();
        };
    </script>
</head>
<body>

<!-- CONTENITORE PRINCIPALE (Registrazione/Votazione/Log) -->
<div id="app-container" class="container-card">
    <div id="main-content">
        <!-- Il contenuto dell'applicazione (registrazione o votazione) verrà iniettato qui -->
        <div class="flex flex-col items-center space-y-4 py-8">
             <i data-lucide="loader" class="animate-spin w-8 h-8 text-blue-500"></i>
             <p class="text-center text-gray-500">Inizializzazione Supabase...</p>
        </div>
    </div>
</div>

<!-- PANNELLO ADMIN SEPARATO -->
<div id="admin-panel" class="hidden bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-300 max-w-[480px] w-[95%]">
    <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2 flex items-center">
        <i data-lucide="key" class="w-5 h-5 mr-2"></i> Pannello di Controllo Admin Separato
    </h3>
    <p class="text-sm text-gray-700 mb-4">ID Admin: <span id="admin-user-id" class="font-mono text-xs bg-yellow-200 p-1 rounded"></span>. Usare questo link per la gestione.</p>
    
    <!-- SEZIONE GESTIONE CODICE -->
    <h4 class="text-lg font-bold text-gray-800 mt-4 border-t pt-4 flex items-center">
        <i data-lucide="lock" class="w-4 h-4 mr-2"></i> 1. Gestione Codice Accesso
    </h4>
    <p class="text-sm text-gray-700 mb-2">Codice Corrente Richiesto: <span id="current-required-code" class="font-mono text-sm bg-blue-100 p-1 rounded font-bold">Nessuno</span></p>
    <input type="text" id="admin-set-code" placeholder="Nuovo Codice Univoco (es. 1234)" class="w-full p-2 border border-gray-400 rounded-lg text-sm mb-2" />
    <button id="update-code-btn" class="w-full py-2 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md">
        Imposta Codice e Abilita Registrazione
    </button>

    <!-- SEZIONE GESTIONE VOTO -->
    <h4 class="text-lg font-bold text-red-700 mt-6 border-t pt-4 flex items-center">
        <i data-lucide="send" class="w-4 h-4 mr-2"></i> 2. Gestione Votazione
    </h4>
    <p class="text-sm text-gray-700 mb-4">Stato Votazione: <span id="voting-status-text" class="font-bold">DISATTIVO</span>.</p>
    
    <div class="space-y-2 mt-4">
        <button id="toggle-voting-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md">
            Attiva Votazione
        </button>
        <button id="reset-results-btn" class="w-full py-2 px-4 rounded-xl text-red-700 border border-red-700 bg-white hover:bg-red-50 transition duration-150 ease-in-out font-semibold shadow-sm">
            Resetta Tutti i Voti (Salva Log)
        </button>
    </div>

    <!-- SEZIONE LOG E PRESENZE -->
    <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4 flex items-center">
        <i data-lucide="book-open" class="w-4 h-4 mr-2"></i> 3. Log e Tracciabilità
    </h4>
    <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="show-attendees-btn" class="py-2 px-2 rounded-xl text-blue-700 border border-blue-700 bg-white hover:bg-blue-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm flex items-center justify-center">
            <i data-lucide="users" class="w-4 h-4 mr-1"></i> Lista Presenti
        </button>
        <button id="show-deliberations-btn" class="py-2 px-2 rounded-xl text-purple-700 border border-purple-700 bg-white hover:bg-purple-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm flex items-center justify-center">
            <i data-lucide="archive" class="w-4 h-4 mr-1"></i> Log Storico
        </button>
    </div>
</div>

<!-- Script Logica Applicativa (Usa Supabase) -->
<script>
    // === CONFIGURAZIONE SUPABASE (CRITICO!) ===
    // I placeholders devono essere sostituiti con i valori reali del TUO progetto Supabase
    
    // Riga 211: NUOVO URL DEL PROGETTO
    const SUPABASE_URL = 'https://iuuvakwbuequapwoyddd.supabase.co'; 
    // Riga 212: NUOVA CHIAVE API ANONIMA
    const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dXZha3didWVxdWFwd295ZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTE5ODEsImV4cCI6MjA3Njg4Nzk4MX0.c7BpXAk8hF0lijNnWaURjQxsZDBv66JvV8NJ1xxX-KI'; 
    
    // Variabili Globali Supabase
    let supabaseClient = null;

    // Stato dell'Applicazione
    let userId = null;
    let isRegistered = false;
    let isVotingActive = false;
    let hasVotedInCurrentRound = false;
    let votingResults = { Favorevole: 0, Contrario: 0, Astenuto: 0 };
    let requiredCode = null; 
    let isViewingLog = false; 
    let isAdminRole = false; 
    let lastResetTimestamp = 0; 
    let isSupabaseReady = false;

    // Elementi UI
    const mainContentEl = document.getElementById('main-content');
    const adminPanelEl = document.getElementById('admin-panel');
    const toggleVotingBtn = document.getElementById('toggle-voting-btn');
    const resetResultsBtn = document.getElementById('reset-results-btn');
    const updateCodeBtn = document.getElementById('update-code-btn'); 
    const adminUserIdEl = document.getElementById('admin-user-id');
    const votingStatusTextEl = document.getElementById('voting-status-text');
    const currentRequiredCodeEl = document.getElementById('current-required-code'); 
    const showAttendeesBtn = document.getElementById('show-attendees-btn'); 
    const showDeliberationsBtn = document.getElementById('show-deliberations-btn'); 

    // --- FUNZIONI DI UTILITÀ ---
    
    // Funzione per generare un ID Utente casuale e persistente
    function getUserId() {
        let uid = localStorage.getItem('votingAppUserId');
        if (!uid) {
            uid = 'user-' + Date.now() + Math.random().toString(16).slice(2);
            localStorage.setItem('votingAppUserId', uid);
        }
        return uid;
    }

    // Funzione per controllare i parametri nell'URL
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Formatta il timestamp (converte ISO a leggibile)
    function formatTimestamp(timestampStr) {
        if (!timestampStr) return 'N/A';
        const date = new Date(timestampStr);
        return date.toLocaleDateString('it-IT', {
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    // Mostra un messaggio all'utente invece di alert()
    function showMessage(message, isError = false) {
        const type = isError ? 'bg-red-500' : 'bg-green-500';
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-semibold ${type} shadow-xl z-50 transition-opacity duration-300`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.addEventListener('transitionend', () => messageEl.remove());
        }, 3000);
    }

    // Controlla la prontezza di Supabase
    function checkSupabaseReady() {
        if (SUPABASE_URL.includes('INSERISCI') || SUPABASE_API_KEY.includes('INSERISCI')) {
            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-red-700 text-center mb-6">ERRORE DI CONFIGURAZIONE</h2>
                <p class="text-gray-700 mb-4">Per favore, inserisci l'URL e la chiave API Supabase anonima nel file index.html (righe 211-212).</p>
            `;
            return false;
        }
        return true;
    }

    // --- FUNZIONI DI INIZIALIZZAZIONE ---

    function initApp() {
        if (!checkSupabaseReady()) return;
        
        // Inizializza il client Supabase (rimuove spazi indesiderati)
        const cleanApiKey = SUPABASE_API_KEY.trim();
        try {
            supabaseClient = supabase.createClient(SUPABASE_URL.trim(), cleanApiKey, {
                realtime: {
                    params: {
                        apikey: cleanApiKey // Forza l'uso della chiave nell'header websocket
                    }
                }
            });
            isSupabaseReady = true;
            console.log("Supabase Client inizializzato con successo.");
        } catch (e) {
            console.error("Errore fatale nell'inizializzazione di Supabase:", e);
            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-red-700 text-center mb-6">ERRORE DI CONNESSIONE</h2>
                <p class="text-gray-700 mb-4">Impossibile inizializzare il client Supabase. Controlla il link e la chiave API.</p>
            `;
            return;
        }

        userId = getUserId();
        isAdminRole = getUrlParameter('role') === 'admin';
        
        const adminIdDisplay = userId.substring(0, 10) + '...';
        adminUserIdEl.textContent = adminIdDisplay;

        if (isAdminRole) {
            adminPanelEl.classList.remove('hidden');
        }
        
        // Inizializza i listener per i pulsanti Admin
        if (adminPanelEl) { 
            toggleVotingBtn.addEventListener('click', handleAdminToggle);
            resetResultsBtn.addEventListener('click', handleResetResults);
            updateCodeBtn.addEventListener('click', handleAdminCodeUpdate); 
            showAttendeesBtn.addEventListener('click', showAttendeesList); 
            showDeliberationsBtn.addEventListener('click', showDeliberationsLog); 
        }

        // Avvia il Realtime Listener
        setupRealtimeListener();
        // Carica lo stato iniziale
        fetchSettingsAndVotes();
    }
    
    // Funzione per il Realtime Listener (per tutti i client)
    function setupRealtimeListener() {
        if (!isSupabaseReady) return;

        // Ascolta i cambiamenti sulla tabella settings (stato di voto e codice)
        supabaseClient.channel('settings_changes')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'settings' }, (payload) => {
                console.log("Realtime: Modifica impostazioni", payload);
                fetchSettingsAndVotes(); // Aggiorna i dati quando le impostazioni cambiano
            })
            .subscribe((status, err) => {
                if (status === 'SUBSCRIBED') {
                    console.log("Supabase Realtime Abilitato.");
                } else if (status === 'CHANNEL_ERROR') {
                    console.error("Errore Realtime:", err);
                }
            });
    }

    // Fetch iniziale dei settings e dei voti (usata anche dal listener)
    async function fetchSettingsAndVotes() {
        if (!isSupabaseReady || isViewingLog) return;
        
        try {
            // 1. Fetch settings (stato di voto e codice)
            const { data: settingsData, error: settingsError } = await supabaseClient
                .from('settings')
                .select('is_voting_active, required_code, id')
                .limit(1)
                .single();

            if (settingsError) throw settingsError;

            isVotingActive = settingsData.is_voting_active;
            requiredCode = settingsData.required_code;

            // 2. Fetch vote counts (usa la funzione SQL)
            const { data: countsData, error: countsError } = await supabaseClient
                .rpc('get_vote_counts');
            
            if (countsError) throw countsError;
            
            // Aggiorna i risultati globali
            const counts = countsData[0];
            votingResults = { 
                Favorevole: counts.yes_votes || 0, 
                Contrario: counts.no_votes || 0, 
                Astenuto: (counts.total_votes - counts.yes_votes - counts.no_votes) || 0
            };
            
            // 3. Aggiorna lo stato di voto locale
            await checkUserVotedStatus();
            
            // 4. Aggiorna la UI
            renderApp();

        } catch (error) {
            console.error("Errore fetch settings e voti:", error);
            // Non mostriamo errore critico se l'app è già inizializzata
        }
    }


    async function checkUserVotedStatus() {
        if (!isSupabaseReady) return;
        
        try {
            // Controlla se l'utente ha votato nella tabella 'votes'
            const { count, error } = await supabaseClient
                .from('votes')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', userId);
            
            if (error) throw error;
            
            hasVotedInCurrentRound = count > 0;
            
        } catch (e) {
            console.error("Errore nel check stato voto:", e);
        }
    }

    async function checkRegistrationStatus() {
        if (!isSupabaseReady || isRegistered) return;
        
        try {
            const { count, error } = await supabaseClient
                .from('attendees')
                .select('id', { count: 'exact', head: true })
                .eq('user_id', userId);
            
            if (error) throw error;
            
            isRegistered = count > 0;
            
        } catch (e) {
            console.error("Errore nel check registrazione:", e);
        }
    }


    // --- FUNZIONI DI AZIONE DELL'UTENTE ---

    async function handleRegistration() {
        if (!isSupabaseReady) return;
        
        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        const codice = document.getElementById('codice').value.trim();

        if (!nome || !cognome || !codice) {
            showMessage("Per favore, compila tutti i campi.", true);
            return;
        }

        if (!requiredCode) {
            showMessage("L'amministratore non ha ancora impostato il codice di accesso.", true);
            return;
        }

        // Nota: Supabase restituisce il codice come stringa, quindi la comparazione è sicura
        if (codice !== requiredCode) {
            showMessage("Codice univoco errato. Per favore, verifica.", true);
            return;
        }
        
        try {
            const { error } = await supabaseClient
                .from('attendees')
                .insert({
                    user_id: userId,
                    nome: nome,
                    cognome: cognome,
                    codice: codice
                });
            
            if (error) throw error;

            isRegistered = true;
            showMessage(`Registrazione di ${nome} ${cognome} completata!`);
            renderApp();
            
        } catch (e) {
            // Controllo errore duplicato (viene gestito dalla chiave unica nell'SQL)
            if (e.code === '23505') { 
                isRegistered = true;
                showMessage("Sei già stato registrato. Passaggio alla votazione.");
                renderApp();
                return;
            }
            console.error("Errore durante la registrazione: ", e);
            showMessage("Errore nel salvataggio della registrazione. Riprova.", true);
        }
    }

    async function handleVote(choice) {
        if (!isSupabaseReady) return;

        if (!isVotingActive) {
            showMessage("La votazione è attualmente disattivata dall'amministrazione.", true);
            return;
        }
        if (hasVotedInCurrentRound) {
            showMessage("Hai già espresso il tuo voto in questa sessione. Attendi il prossimo voto.", true);
            return;
        }

        // Il voto è TRUE per Favorevole, FALSE per Contrario. Astenuto non viene registrato come voto diretto
        // ma è un'azione
        const voteValue = choice === 'Favorevole' ? true : choice === 'Contrario' ? false : null;

        try {
            const { error } = await supabaseClient
                .from('votes')
                .insert({
                    user_id: userId,
                    vote: voteValue,
                    choice: choice // Salva la scelta testuale anche
                });

            if (error) throw error;

            // Stato locale aggiornato per prevenire il doppio voto immediato
            hasVotedInCurrentRound = true;
            showMessage(`Voto espresso: ${choice}. Grazie!`);
            
        } catch (e) {
            // Controllo errore duplicato (gestito dalla chiave unica nell'SQL)
            if (e.code === '23505') { 
                hasVotedInCurrentRound = true;
                showMessage("Hai già votato per questa mozione.", true);
                renderApp();
                return;
            }
            console.error("Errore durante la votazione: ", e);
            showMessage("Errore durante l'invio del voto. Riprova.", true);
        }
    }
    
    // --- FUNZIONI DI AZIONE ADMIN ---
    
    async function handleAdminCodeUpdate() {
        if (!isSupabaseReady || !isAdminRole) return;
        
        const newCode = document.getElementById('admin-set-code').value.trim();
        if (!newCode) {
            showMessage("Inserisci un codice valido.", true);
            return;
        }

        try {
            // Chiama la funzione SQL che aggiorna il codice nella riga 1 (ID 1 è il setting)
            const { error } = await supabaseClient.rpc('update_admin_settings', {
                new_code: newCode,
                is_voting_active: isVotingActive // Mantiene lo stato di voto attuale
            });

            if (error) throw error;
            showMessage(`Codice impostato a ${newCode}.`);

        } catch (e) {
            console.error("Errore nell'aggiornamento del codice Admin: ", e);
            showMessage("Errore nel salvataggio del codice.", true);
        }
    }

    async function handleAdminToggle() {
        if (!isSupabaseReady || !isAdminRole) return; 
        
        const newState = !isVotingActive;

        try {
            // Chiama la funzione SQL che aggiorna lo stato nella riga 1
            const { error } = await supabaseClient.rpc('update_admin_settings', {
                new_code: requiredCode, // Mantiene il codice attuale
                is_voting_active: newState
            });

            if (error) throw error;
            showMessage(`Votazione ${newState ? 'ATTIVATA' : 'DISATTIVATA'}.`);

        } catch (e) {
            console.error("Errore nel toggle Admin: ", e);
            showMessage("Errore nel cambio stato votazione.", true);
        }
    }

    async function handleResetResults() {
        if (!isSupabaseReady || !isAdminRole) return; 

        try {
            // 1. Log del risultato (solo se ci sono voti validi)
            const totalVotes = votingResults.Favorevole + votingResults.Contrario + votingResults.Astenuto;
            
            if (totalVotes > 0) {
                 const { error: logError } = await supabaseClient
                    .from('log')
                    .insert({
                        voti_favorevoli: votingResults.Favorevole,
                        voti_contrari: votingResults.Contrario,
                        voti_astenuti: votingResults.Astenuto,
                        presenti: votingResults.attendee_count // Da implementare
                    });

                if (logError) throw logError;
            }

            // 2. Cancella i voti e le presenze
            const { error: deleteVotesError } = await supabaseClient.from('votes').delete().neq('id', 0);
            if (deleteVotesError) throw deleteVotesError;

            const { error: deleteAttendeesError } = await supabaseClient.from('attendees').delete().neq('id', 0);
            if (deleteAttendeesError) throw deleteAttendeesError;

            showMessage(`Voti e Presenze resettati. Log salvato.`);
            
        } catch (e) {
            console.error("Errore nel reset dei voti: ", e);
            showMessage("Errore nel reset dei voti. Riprova.", true);
        }
    }
    
    // --- FUNZIONI DI VISUALIZZAZIONE ADMIN ---

    async function showAttendeesList() {
        if (!isSupabaseReady || !isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<div class="text-center text-gray-500 py-6"><i data-lucide="loader" class="animate-spin w-6 h-6 text-blue-500 mx-auto"></i><p>Caricamento lista presenti...</p></div>';
        lucide.createIcons();
        
        try {
            const { data, error } = await supabaseClient
                .from('attendees')
                .select('nome, cognome, created_at')
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            let listHtml = data.length === 0 
                ? '<p class="text-center text-gray-500 p-4">Nessun docente registrato finora.</p>'
                : `<ul class="log-list divide-y divide-gray-200">
                    ${data.map(row => {
                        return `
                            <li class="p-3 flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-900">${row.nome} ${row.cognome}</span>
                                <span class="text-gray-500 text-xs">${formatTimestamp(row.created_at)}</span>
                            </li>
                        `;
                    }).join('')}
                </ul>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Lista Docenti Presenti (${data.length})</h2>
                ${listHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                renderApp();
            });
            lucide.createIcons();

        } catch (e) {
            console.error("Errore nel caricamento lista presenti:", e);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento della lista.</p>';
        }
    }

    async function showDeliberationsLog() {
        if (!isSupabaseReady || !isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<div class="text-center text-gray-500 py-6"><i data-lucide="loader" class="animate-spin w-6 h-6 text-blue-500 mx-auto"></i><p>Caricamento log storico delle delibere...</p></div>';
        lucide.createIcons();

        try {
            const { data, error } = await supabaseClient
                .from('log')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            let logHtml = data.length === 0
                ? '<p class="text-center text-gray-500 p-4">Nessuna votazione storica salvata finora.</p>'
                : `<div class="log-list space-y-4">
                    ${data.map((row, index) => {
                        const totalVoti = row.voti_favorevoli + row.voti_contrari + row.voti_astenuti;
                        return `
                            <div class="p-3 border rounded-lg shadow-sm bg-white">
                                <p class="text-sm font-bold text-gray-800 mb-1">Delibera #${data.length - index} - Voti: ${totalVoti} / Presenti: ${row.presenti || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mb-2">${formatTimestamp(row.created_at)}</p>
                                <div class="grid grid-cols-3 gap-1 text-xs font-semibold">
                                    <span class="p-1 bg-green-100 text-green-700 rounded text-center">F: ${row.voti_favorevoli}</span>
                                    <span class="p-1 bg-red-100 text-red-700 rounded text-center">C: ${row.voti_contrari}</span>
                                    <span class="p-1 bg-yellow-100 text-yellow-700 rounded text-center">A: ${row.voti_astenuti}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Log Storico Votazioni (${data.length})</h2>
                ${logHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                renderApp();
            });
            lucide.createIcons();


        } catch (e) {
            console.error("Errore nel caricamento log storico:", e);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento del log storico.</p>';
        }
    }

    // --- FUNZIONE DI RENDERING (Mostra la pagina corretta) ---
    
    function renderApp() {
        if (!isSupabaseReady || isViewingLog) return;
        
        // Aggiorna lo stato nel pannello Admin
        if (isAdminRole) {
            votingStatusTextEl.textContent = isVotingActive ? 'ATTIVO' : 'DISATTIVO';
            votingStatusTextEl.className = isVotingActive ? 'font-bold text-green-600' : 'font-bold text-red-600';
            toggleVotingBtn.textContent = isVotingActive ? 'Disattiva Votazione' : 'Attiva Votazione';
            toggleVotingBtn.className = isVotingActive ? 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-green-600 hover:bg-green-700 shadow-md' : 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md';
            
            currentRequiredCodeEl.textContent = requiredCode || 'Nessuno';
            lucide.createIcons();
        }

        // Il rendering completo avviene solo se l'utente non è sulla pagina di registrazione e non è registrato.
        if (isRegistered || mainContentEl.querySelector('#nome') === null) {
            // Esegui il rendering normale (o della pagina di voto)
            mainContentEl.innerHTML = ''; 
            if (!isRegistered) {
                checkRegistrationStatus(); 
                renderRegistrationPage(); 
            } else {
                renderVotingPage(); 
            }
        }
    }

    function renderRegistrationPage() {
        checkRegistrationStatus();
        
        // Preserva i valori attuali dei campi prima di ricreare il DOM
        const savedNome = document.getElementById('nome')?.value || '';
        const savedCognome = document.getElementById('cognome')?.value || '';
        const savedCodice = document.getElementById('codice')?.value || '';
        
        const codeStatus = requiredCode 
            ? '<p class="text-sm text-green-600 text-center font-semibold mb-4">Codice di accesso ATTIVO. Inserisci il codice comunicato.</p>'
            : '<p class="text-sm text-red-600 text-center font-semibold mb-4">Codice di accesso NON ancora impostato dall\'amministratore.</p>';

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6 flex items-center justify-center">
                <i data-lucide="edit" class="w-6 h-6 mr-2 text-blue-600"></i> <span class="text-blue-600">Registro</span> Presenze Collegio
            </h2>
            <div class="p-3 mb-4 rounded-xl bg-gray-50 border border-gray-200">
                <p class="text-sm text-gray-600 text-center">ID Utente: <span class="font-mono text-xs bg-gray-200 p-1 rounded">${userId || 'Caricamento...'}</span></p>
            </div>
            ${isRegistered ? 
                '<p class="text-lg text-green-600 font-bold text-center mb-4">Presenza Registrata. Vai al voto!</p>'
                : codeStatus
            }
            <div class="space-y-4">
                <input type="text" id="nome" placeholder="Nome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedNome}" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="cognome" placeholder="Cognome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedCognome}" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="codice" placeholder="Codice Univoco Collegio" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedCodice}" ${isRegistered ? 'disabled' : ''}/>
                
                <button id="register-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg ${isRegistered ? 'opacity-50 cursor-not-allowed' : ''}" ${isRegistered ? 'disabled' : ''}>
                    Registra Presenza
                </button>
            </div>
        `;
        document.getElementById('register-btn')?.addEventListener('click', handleRegistration);
        lucide.createIcons();

    }

    function renderVotingPage() {
        const statusClass = isVotingActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const statusText = isVotingActive ? 'Votazione Attiva: Esprimi il tuo voto.' : 'Votazione Chiusa: Attendi l\'attivazione.';
        const disabledClass = isVotingActive && !hasVotedInCurrentRound ? '' : 'opacity-50 cursor-not-allowed';
        const buttonDisabled = isVotingActive && !hasVotedInCurrentRound ? '' : 'disabled';
        
        let voteMessage = '';
        if (hasVotedInCurrentRound) {
            voteMessage = '<p class="text-center text-sm text-yellow-700 p-2 bg-yellow-50 rounded-lg flex items-center justify-center"><i data-lucide="check-circle" class="w-4 h-4 mr-1"></i>Hai già votato per la mozione corrente.</p>';
        }

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6 flex items-center justify-center">
                <i data-lucide="bar-chart-3" class="w-6 h-6 mr-2 text-blue-600"></i> <span class="text-blue-600">Votazione</span> in Corso
            </h2>
            <div class="p-4 rounded-xl mb-6 font-semibold text-center ${statusClass}">
                ${statusText}
            </div>
            
            ${voteMessage}
            
            <div class="grid grid-cols-1 gap-4">
                <button data-vote="Favorevole" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-green-600 hover:bg-green-700 ${disabledClass} shadow-lg flex justify-between items-center">
                    Favorevole 
                    <span class="bg-white text-green-600 py-1 px-3 rounded-full text-sm">${votingResults.Favorevole}</span>
                </button>
                <button data-vote="Contrario" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-red-600 hover:bg-red-700 ${disabledClass} shadow-lg flex justify-between items-center">
                    Contrario 
                    <span class="bg-white text-red-600 py-1 px-3 rounded-full text-sm">${votingResults.Contrario}</span>
                </button>
                <button data-vote="Astenuto" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-gray-800 font-bold text-lg bg-yellow-400 hover:bg-yellow-500 ${disabledClass} shadow-lg flex justify-between items-center">
                    Astenuto 
                    <span class="bg-white text-yellow-600 py-1 px-3 rounded-full text-sm">${votingResults.Astenuto}</span>
                </button>
            </div>
        `;
        document.querySelectorAll('.vote-btn').forEach(button => {
            if (!button.disabled) {
                button.addEventListener('click', () => handleVote(button.dataset.vote));
            }
        });
        lucide.createIcons();

    }

    // Inizializza l'app all'avvio
    initApp();

</script>
</body>
</html>
