<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti</title>
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Stile personalizzato per il corpo e i pulsanti */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            /* Modificato per impilare verticalmente e mantenere il centraggio */
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
            width: 95%;
            margin-bottom: 1.5rem; /* Aggiunto margine inferiore per separazione */
        }
        .vote-btn {
            transition: all 0.2s;
            transform: scale(1.0);
        }
        .vote-btn:hover:not(.opacity-50) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .vote-btn:active:not(.opacity-50) {
            transform: scale(0.98);
        }
        .log-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
    <!-- Configurazione del Font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body>

<!-- CONTENITORE PRINCIPALE (Registrazione/Votazione/Log) -->
<div id="app-container" class="container-card">
    <div id="main-content">
        <!-- Il contenuto dell'applicazione (registrazione o votazione) verrà iniettato qui -->
        <p class="text-center text-gray-500">Caricamento in corso...</p>
    </div>
</div>

<!-- PANNELLO ADMIN SEPARATO -->
<div id="admin-panel" class="hidden bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-300 max-w-[480px] w-[95%]">
    <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Pannello di Controllo Admin Separato</h3>
    <p class="text-sm text-gray-700 mb-4">ID Admin: <span id="admin-user-id" class="font-mono text-xs bg-yellow-200 p-1 rounded"></span>. Usare questo link per la gestione.</p>
    
    <!-- SEZIONE GESTIONE CODICE -->
    <h4 class="text-lg font-bold text-gray-800 mt-4 border-t pt-4">1. Gestione Codice Accesso</h4>
    <p class="text-sm text-gray-700 mb-2">Codice Corrente Richiesto: <span id="current-required-code" class="font-mono text-sm bg-blue-100 p-1 rounded font-bold">Nessuno</span></p>
    <input type="text" id="admin-set-code" placeholder="Nuovo Codice Univoco (es. 1234)" class="w-full p-2 border border-gray-400 rounded-lg text-sm mb-2" />
    <button id="update-code-btn" class="w-full py-2 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md">
        Imposta Codice e Abilita Registrazione
    </button>

    <!-- SEZIONE GESTIONE VOTO -->
    <h4 class="text-lg font-bold text-red-700 mt-6 border-t pt-4">2. Gestione Votazione</h4>
    <p class="text-sm text-gray-700 mb-4">Stato Votazione: <span id="voting-status-text" class="font-bold">DISATTIVO</span>.</p>
    
    <div class="space-y-2 mt-4">
        <button id="toggle-voting-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md">
            Attiva Votazione
        </button>
        <button id="reset-results-btn" class="w-full py-2 px-4 rounded-xl text-red-700 border border-red-700 bg-white hover:bg-red-50 transition duration-150 ease-in-out font-semibold shadow-sm">
            Resetta Tutti i Voti (Salva Log)
        </button>
    </div>

    <!-- SEZIONE LOG E PRESENZE -->
    <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4">3. Log e Tracciabilità</h4>
    <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="show-attendees-btn" class="py-2 px-2 rounded-xl text-blue-700 border border-blue-700 bg-white hover:bg-blue-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            Mostra Lista Presenti
        </button>
        <button id="show-deliberations-btn" class="py-2 px-2 rounded-xl text-purple-700 border border-purple-700 bg-white hover:bg-purple-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            Mostra Log Storico
        </button>
    </div>
</div>

<!-- Script Logica Applicativa (NON USA FIREBASE) -->
<script>
    // URL della Web App Google Sheets che gestisce le richieste.
    // DEVE essere aggiornato dopo ogni pubblicazione dello script GAS.
    // === ATTENZIONE: IL TUO LINK È ORA INCOLLATO QUI SOTTO. NON MODIFICARE. ===
    const SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzp2R4ERD8bLe5Pa7zVtJJxZa_6J2DlTrxT0eeT1VVtx_2KEiv4fO9394jykxljBs9p/exec'; 

    // Stato dell'Applicazione
    let userId = null;
    let isRegistered = false;
    let isVotingActive = false;
    let hasVotedInCurrentRound = false;
    let votingResults = { Favorevole: 0, Contrario: 0, Astenuto: 0 };
    let requiredCode = null; 
    let isViewingLog = false; 
    let isAdminRole = false; 
    let lastResetTimestamp = 0; // Utilizzato per il check del voto

    // Elementi UI
    const mainContentEl = document.getElementById('main-content');
    const adminPanelEl = document.getElementById('admin-panel');
    const toggleVotingBtn = document.getElementById('toggle-voting-btn');
    const resetResultsBtn = document.getElementById('reset-results-btn');
    const updateCodeBtn = document.getElementById('update-code-btn'); 
    const adminUserIdEl = document.getElementById('admin-user-id');
    const votingStatusTextEl = document.getElementById('voting-status-text');
    const currentRequiredCodeEl = document.getElementById('current-required-code'); 
    const showAttendeesBtn = document.getElementById('show-attendees-btn'); 
    const showDeliberationsBtn = document.getElementById('show-deliberations-btn'); 


    // --- FUNZIONI DI UTILITÀ ---

    // Funzione per generare un ID Utente casuale e persistente (sostituisce l'auth di Firebase)
    function getUserId() {
        let uid = localStorage.getItem('votingAppUserId');
        if (!uid) {
            // Genera un UUID v4
            uid = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
            localStorage.setItem('votingAppUserId', uid);
        }
        return uid;
    }

    // Funzione per controllare i parametri nell'URL
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    // Formatta il timestamp
    function formatTimestamp(timestampStr) {
        if (!timestampStr) return 'N/A';
        const date = new Date(timestampStr);
        return date.toLocaleDateString('it-IT', {
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    // Mostra un messaggio all'utente invece di alert()
    function showMessage(message, isError = false) {
        const type = isError ? 'bg-red-500' : 'bg-green-500';
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-semibold ${type} shadow-xl z-50 transition-opacity duration-300`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.addEventListener('transitionend', () => messageEl.remove());
        }, 3000);
    }
    
    // Funzione per inviare richieste al Google Apps Script (GAS)
    async function fetchFromGAS(action, params = {}) {
        if (SHEET_WEB_APP_URL === 'YOUR_GAS_WEB_APP_URL') {
            throw new Error("API URL non configurato. Incolla il link della Web App di Google Sheets nel codice.");
        }
        
        const url = new URL(SHEET_WEB_APP_URL);
        url.searchParams.append('action', action);
        url.searchParams.append('userId', userId);
        
        for (const key in params) {
            url.searchParams.append(key, params[key]);
        }

        try {
            const response = await fetch(url.toString(), {
                method: 'GET', // Usiamo GET per semplicità, gestito da doGet in GAS
            });

            if (!response.ok) {
                throw new Error(`Errore HTTP: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'error') {
                throw new Error(result.message);
            }
            return result;
        } catch (error) {
            console.error(`Errore nell'azione ${action}:`, error.message);
            throw new Error(`Connessione fallita. Controlla lo script GAS.`);
        }
    }


    // --- FUNZIONI DI INIZIALIZZAZIONE ---

    function initApp() {
        userId = getUserId();
        isAdminRole = getUrlParameter('role') === 'admin';
        
        // Nel modello Sheets, l'AdminUserId è l'ID del client che ha caricato la pagina admin
        // Se non è l'admin, adminUserId rimane null, ma l'ID dell'utente è visibile
        const adminIdDisplay = userId.substring(0, 10) + '...';
        adminUserIdEl.textContent = adminIdDisplay;

        if (isAdminRole) {
            adminPanelEl.classList.remove('hidden');
        }
        
        // Inizializza i listener per i pulsanti Admin
        if (adminPanelEl) { 
            toggleVotingBtn.addEventListener('click', handleAdminToggle);
            resetResultsBtn.addEventListener('click', handleResetResults);
            updateCodeBtn.addEventListener('click', handleAdminCodeUpdate); 
            showAttendeesBtn.addEventListener('click', showAttendeesList); 
            showDeliberationsBtn.addEventListener('click', showDeliberationsLog); 
        }

        // Avvia il loop di polling (simulazione del listener in tempo reale)
        startPollingLoop();
    }
    
    // Simula i listener in tempo reale (polling)
    function startPollingLoop() {
        setInterval(async () => {
            if (isViewingLog) return; // Non aggiornare se stiamo visualizzando i log
            
            try {
                const statusData = await fetchFromGAS('get_status');
                
                isVotingActive = statusData.isVotingActive;
                requiredCode = statusData.requiredCode;
                votingResults = statusData.results;
                
                // Aggiorna lo stato nel pannello Admin
                if (isAdminRole) {
                    votingStatusTextEl.textContent = isVotingActive ? 'ATTIVO' : 'DISATTIVO';
                    votingStatusTextEl.className = isVotingActive ? 'font-bold text-green-600' : 'font-bold text-red-600';
                    toggleVotingBtn.textContent = isVotingActive ? 'Disattiva Votazione' : 'Attiva Votazione';
                    toggleVotingBtn.className = isVotingActive ? 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-green-600 hover:bg-green-700 shadow-md' : 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md';
                    
                    currentRequiredCodeEl.textContent = requiredCode || 'Nessuno';
                }
                
                // Aggiorna lo stato di voto per l'utente corrente
                await checkUserVotedStatus();
                
                renderApp();
            } catch (e) {
                console.error("Errore nel polling:", e);
                if (mainContentEl.innerHTML.indexOf('ERRORE CRITICO') === -1) {
                     mainContentEl.innerHTML = `
                        <h2 class="text-2xl font-extrabold text-red-700 text-center mb-6">ERRORE CRITICO DI CONNESSIONE</h2>
                        <p class="text-gray-700 mb-4">L'app non riesce a comunicare con Google Sheets.</p>
                        <p class="text-sm text-gray-600 mb-4">Verifica che l'URL nella variabile <span class="font-mono text-xs bg-gray-200 p-1 rounded">SHEET_WEB_APP_URL</span> sia corretto e che lo script GAS sia stato pubblicato come "Web app" accessibile a "Chiunque".</p>
                    `;
                }
            }
        }, 1500); // Polling ogni 1.5 secondi
    }

    async function checkUserVotedStatus() {
        // Poiché non possiamo fare query complesse su Sheets direttamente,
        // ci affidiamo all'HTML per verificare se l'utente ha votato
        // dopo l'ultimo reset.
        
        // Questo è solo un controllo LOCAL storage basato sull'ultimo voto
        // e non è infallibile, ma è la soluzione più semplice con Sheets.
        
        const userLastVote = localStorage.getItem('lastVoteTimestamp');
        const userHasVoted = localStorage.getItem(`hasVoted_${userId}`);

        // Controlla se il voto è stato espresso dopo l'ultima ora di reset
        if (userHasVoted === 'true' && userLastVote && lastResetTimestamp && userLastVote < lastResetTimestamp) {
             // Il voto è vecchio, lo resetta
             localStorage.removeItem(`hasVoted_${userId}`);
             localStorage.removeItem('lastVoteTimestamp');
             hasVotedInCurrentRound = false;
        } else if (userHasVoted === 'true') {
            hasVotedInCurrentRound = true;
        } else {
            hasVotedInCurrentRound = false;
        }
        
        // Controllo aggiuntivo: cerca l'utente nel foglio Voti
        // Questa è la verifica più robusta (da implementare in un sistema più complesso)

    }
    
    // Simula la funzione checkRegistrationStatus di Firebase
    async function checkRegistrationStatus() {
        if (isRegistered) return;
        
        try {
            const attendeesData = await fetchFromGAS('get_attendees');
            
            if (attendeesData.data) {
                // Il terzo elemento nell'array del log è l'userId
                const found = attendeesData.data.some(row => row[1] === userId); 
                isRegistered = found;
            }
            
        } catch (e) {
            console.error("Errore nel check registrazione:", e);
        }
    }


    // --- FUNZIONI DI AZIONE DELL'UTENTE ---

    async function handleRegistration() {
        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        const codice = document.getElementById('codice').value.trim();

        if (!nome || !cognome || !codice) {
            showMessage("Per favore, compila tutti i campi.", true);
            return;
        }

        if (!requiredCode) {
            showMessage("L'amministratore non ha ancora impostato il codice di accesso.", true);
            return;
        }

        if (codice !== requiredCode) {
            showMessage("Codice univoco errato. Per favore, verifica.", true);
            return;
        }
        
        try {
            const result = await fetchFromGAS('register', {
                nome: nome,
                cognome: cognome,
                codice: codice
            });
            
            isRegistered = true;
            showMessage(`Registrazione di ${nome} ${cognome} completata! Benvenuto/a.`);
            renderApp();
            
        } catch (e) {
            if (e.message.includes('Già registrato')) {
                isRegistered = true;
                showMessage("Sei già stato registrato. Passaggio alla votazione.");
                renderApp();
                return;
            }
            console.error("Errore durante la registrazione: ", e);
            showMessage("Errore nel salvataggio della registrazione. Riprova.", true);
        }
    }

    async function handleVote(choice) {
        if (!isVotingActive) {
            showMessage("La votazione è attualmente disattivata dall'amministrazione.", true);
            return;
        }
        if (hasVotedInCurrentRound) {
            showMessage("Hai già espresso il tuo voto in questa sessione. Attendi il prossimo voto.", true);
            return;
        }

        try {
            const result = await fetchFromGAS('vote', {
                vote: choice,
            });

            // Stato locale aggiornato per prevenire il doppio voto immediato
            localStorage.setItem(`hasVoted_${userId}`, 'true');
            localStorage.setItem('lastVoteTimestamp', new Date().getTime());
            hasVotedInCurrentRound = true;
            
            showMessage(`Voto espresso: ${choice}. Grazie!`);
            
        } catch (e) {
            if (e.message.includes('Hai già votato')) {
                localStorage.setItem(`hasVoted_${userId}`, 'true');
                hasVotedInCurrentRound = true;
                showMessage("Hai già votato per questa mozione.", true);
                renderApp();
                return;
            }
            console.error("Errore durante la votazione: ", e);
            showMessage("Errore durante l'invio del voto. Riprova.", true);
        }
    }
    
    // --- FUNZIONI DI AZIONE ADMIN ---
    
    async function handleAdminCodeUpdate() {
        if (!isAdminRole) return;
        
        const newCode = document.getElementById('admin-set-code').value.trim();
        if (!newCode) {
            showMessage("Inserisci un codice valido.", true);
            return;
        }

        try {
            const result = await fetchFromGAS('update_code', {
                newCode: newCode
            });
            showMessage(result.message); // Messaggio da GAS: "Codice impostato a X"
        } catch (e) {
            console.error("Errore nell'aggiornamento del codice Admin: ", e);
            showMessage("Errore nel salvataggio del codice.", true);
        }
    }

    async function handleAdminToggle() {
        if (!isAdminRole) return; 
        
        try {
            const result = await fetchFromGAS('toggle_vote');
            showMessage(`Votazione ${result.isVotingActive ? 'ATTIVATA' : 'DISATTIVATA'}.`);
        } catch (e) {
            console.error("Errore nel toggle Admin: ", e);
            showMessage("Errore nel cambio stato votazione.", true);
        }
    }

    async function handleResetResults() {
        if (!isAdminRole) return; 

        try {
            const result = await fetchFromGAS('reset_results');
            
            // Aggiorna il timestamp di reset locale
            lastResetTimestamp = new Date().getTime();
            localStorage.setItem('lastResetTimestamp', lastResetTimestamp);
            
            // Rimuove lo stato di voto locale per tutti gli utenti
            localStorage.removeItem(`hasVoted_${userId}`);
            
            showMessage(result.message); // Messaggio da GAS: "Voti e Presenze resettati. Log salvato."
            
        } catch (e) {
            console.error("Errore nel reset dei voti: ", e);
            showMessage("Errore nel reset dei voti. Riprova.", true);
        }
    }
    
    // --- FUNZIONI DI VISUALIZZAZIONE ADMIN ---

    async function showAttendeesList() {
        if (!isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<p class="text-center text-gray-500">Caricamento lista presenti...</p>';

        try {
            const attendeesData = await fetchFromGAS('get_attendees');
            const data = attendeesData.data || [];
            
            let listHtml = data.length === 0 
                ? '<p class="text-center text-gray-500 p-4">Nessun docente registrato finora.</p>'
                : `<ul class="log-list divide-y divide-gray-200">
                    ${data.reverse().map(row => { // Reverse per mostrare i più recenti in alto
                        return `
                            <li class="p-3 flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-900">${row[3]} ${row[2]}</span>
                                <span class="text-gray-500 text-xs">${formatTimestamp(row[0])}</span>
                            </li>
                        `;
                    }).join('')}
                </ul>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Lista Docenti Presenti (${data.length})</h2>
                ${listHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                renderApp();
            });

        } catch (e) {
            console.error("Errore nel caricamento lista presenti:", e);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento della lista.</p>';
        }
    }

    async function showDeliberationsLog() {
        if (!isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<p class="text-center text-gray-500">Caricamento log storico delle delibere...</p>';
        
        try {
            const logData = await fetchFromGAS('get_log');
            const data = logData.data || [];
            
            let logHtml = data.length === 0
                ? '<p class="text-center text-gray-500 p-4">Nessuna votazione storica salvata finora.</p>'
                : `<div class="log-list space-y-4">
                    ${data.reverse().map((row, index) => { // Reverse per mostrare i più recenti in alto
                        // Colonna: [0]timestamp, [1]attendees, [2]favorevole, [3]contrario, [4]astenuto
                        const totalVoti = row[2] + row[3] + row[4];
                        return `
                            <div class="p-3 border rounded-lg shadow-sm bg-white">
                                <p class="text-sm font-bold text-gray-800 mb-1">Delibera #${data.length - index} - Voti: ${totalVoti} / Presenti: ${row[1] || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mb-2">${formatTimestamp(row[0])}</p>
                                <div class="grid grid-cols-3 gap-1 text-xs font-semibold">
                                    <span class="p-1 bg-green-100 text-green-700 rounded text-center">F: ${row[2]}</span>
                                    <span class="p-1 bg-red-100 text-red-700 rounded text-center">C: ${row[3]}</span>
                                    <span class="p-1 bg-yellow-100 text-yellow-700 rounded text-center">A: ${row[4]}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Log Storico Votazioni (${data.length})</h2>
                ${logHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                renderApp();
            });

        } catch (e) {
            console.error("Errore nel caricamento log storico:", e);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento del log storico.</p>';
        }
    }

    // --- FUNZIONE DI RENDERING (Mostra la pagina corretta) ---
    
    function renderApp() {
        if (isViewingLog) return; 
        
        mainContentEl.innerHTML = ''; 

        if (!isRegistered) {
            checkRegistrationStatus(); // Riprova il check ad ogni render
            renderRegistrationPage(); 
        } else {
            renderVotingPage(); 
        }
    }

    function renderRegistrationPage() {
        const codeStatus = requiredCode 
            ? '<p class="text-sm text-green-600 text-center font-semibold mb-4">Codice di accesso ATTIVO. Inserisci il codice comunicato.</p>'
            : '<p class="text-sm text-red-600 text-center font-semibold mb-4">Codice di accesso NON ancora impostato dall\'amministratore.</p>';

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6">
                <span class="text-blue-600">Registro</span> Presenze Collegio
            </h2>
            <div class="p-3 mb-4 rounded-xl bg-gray-50 border border-gray-200">
                <p class="text-sm text-gray-600 text-center">ID Utente: <span class="font-mono text-xs bg-gray-200 p-1 rounded">${userId || 'Caricamento...'}</span></p>
            </div>
            ${isRegistered ? 
                '<p class="text-lg text-green-600 font-bold text-center mb-4">Presenza Registrata. Vai al voto!</p>'
                : codeStatus
            }
            <div class="space-y-4">
                <input type="text" id="nome" placeholder="Nome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="cognome" placeholder="Cognome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="codice" placeholder="Codice Univoco Collegio" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" ${isRegistered ? 'disabled' : ''}/>
                
                <button id="register-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg ${isRegistered ? 'opacity-50 cursor-not-allowed' : ''}" ${isRegistered ? 'disabled' : ''}>
                    Registra Presenza
                </button>
            </div>
        `;
        document.getElementById('register-btn')?.addEventListener('click', handleRegistration);
    }

    function renderVotingPage() {
        // ... (Logica di rendering Pagina Votazione)
        const statusClass = isVotingActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const statusText = isVotingActive ? 'Votazione Attiva: Esprimi il tuo voto.' : 'Votazione Chiusa: Attendi l\'attivazione.';
        const disabledClass = isVotingActive && !hasVotedInCurrentRound ? '' : 'opacity-50 cursor-not-allowed';
        const buttonDisabled = isVotingActive && !hasVotedInCurrentRound ? '' : 'disabled';
        
        let voteMessage = '';
        if (hasVotedInCurrentRound) {
            voteMessage = '<p class="text-center text-sm text-yellow-700 p-2 bg-yellow-50 rounded-lg">Hai già votato per la mozione corrente.</p>';
        }


        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6">
                <span class="text-blue-600">Votazione</span> in Corso
            </h2>
            <div class="p-4 rounded-xl mb-6 font-semibold text-center ${statusClass}">
                ${statusText}
            </div>
            
            ${voteMessage}
            
            <div class="grid grid-cols-1 gap-4">
                <button data-vote="Favorevole" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-green-600 hover:bg-green-700 ${disabledClass} shadow-lg">
                    Favorevole (${votingResults.Favorevole})
                </button>
                <button data-vote="Contrario" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-red-600 hover:bg-red-700 ${disabledClass} shadow-lg">
                    Contrario (${votingResults.Contrario})
                </button>
                <button data-vote="Astenuto" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-gray-800 font-bold text-lg bg-yellow-400 hover:bg-yellow-500 ${disabledClass} shadow-lg">
                    Astenuto (${votingResults.Astenuto})
                </button>
            </div>
            
            <div class="mt-8 pt-4 border-t border-gray-200">
                <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">Risultati Aggregati in Tempo Reale</h3>
                <div class="grid grid-cols-3 gap-2 text-center font-bold">
                    <div class="p-2 bg-green-100 rounded-lg">Favorevole: ${votingResults.Favorevole}</div>
                    <div class="p-2 bg-red-100 rounded-lg">Contrario: ${votingResults.Contrario}</div>
                    <div class="p-2 bg-yellow-100 rounded-lg">Astenuto: ${votingResults.Astenuto}</div>
                </div>
                <p class="text-sm text-gray-500 text-center mt-2">Totale Voti: ${votingResults.Favorevole + votingResults.Contrario + votingResults.Astenuto}</p>
            </div>
        `;
        
        document.querySelectorAll('.vote-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!button.disabled) {
                    handleVote(e.target.dataset.vote);
                }
            });
        });
    }

    // Avvia l'app
    window.onload = initApp;
</script>

</body>
</html>
