<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti - Supabase</title>
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inclusione della libreria Supabase client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Stile personalizzato per il corpo e i pulsanti */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1rem;
        }
        .container-card {
            background-color: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px;
            width: 95%;
            margin-bottom: 1.5rem;
        }
        .vote-btn {
            transition: all 0.2s;
            transform: scale(1.0);
        }
        .vote-btn:hover:not(.opacity-50) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .vote-btn:active:not(.opacity-50) {
            transform: scale(0.98);
        }
        .log-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
        }
    </style>
    <!-- Configurazione del Font Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body>

<!-- CONTENITORE PRINCIPALE (Registrazione/Votazione/Log) -->
<div id="app-container" class="container-card">
    <div id="main-content">
        <p class="text-center text-gray-500">Inizializzazione Supabase...</p>
    </div>
</div>

<!-- PANNELLO ADMIN SEPARATO -->
<div id="admin-panel" class="hidden bg-gray-100 p-6 rounded-xl shadow-lg border border-gray-300 max-w-[480px] w-[95%]">
    <h3 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Pannello di Controllo Admin Separato</h3>
    <p class="text-sm text-gray-700 mb-4">ID Admin: <span id="admin-user-id" class="font-mono text-xs bg-yellow-200 p-1 rounded"></span>. Usare questo link per la gestione.</p>
    
    <!-- SEZIONE GESTIONE CODICE -->
    <h4 class="text-lg font-bold text-gray-800 mt-4 border-t pt-4">1. Gestione Codice Accesso</h4>
    <p class="text-sm text-gray-700 mb-2">Codice Corrente Richiesto: <span id="current-required-code" class="font-mono text-sm bg-blue-100 p-1 rounded font-bold">Nessuno</span></p>
    <input type="text" id="admin-set-code" placeholder="Nuovo Codice Univoco (es. 1234)" class="w-full p-2 border border-gray-400 rounded-lg text-sm mb-2" />
    <button id="update-code-btn" class="w-full py-2 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md">
        Imposta Codice e Abilita Registrazione
    </button>

    <!-- SEZIONE GESTIONE VOTO -->
    <h4 class="text-lg font-bold text-red-700 mt-6 border-t pt-4">2. Gestione Votazione</h4>
    <p class="text-sm text-gray-700 mb-4">Stato Votazione: <span id="voting-status-text" class="font-bold">DISATTIVO</span>.</p>
    
    <div class="space-y-2 mt-4">
        <button id="toggle-voting-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md">
            Attiva Votazione
        </button>
        <button id="reset-results-btn" class="w-full py-2 px-4 rounded-xl text-red-700 border border-red-700 bg-white hover:bg-red-50 transition duration-150 ease-in-out font-semibold shadow-sm">
            Resetta Tutti i Voti (Salva Log)
        </button>
    </div>

    <!-- SEZIONE LOG E PRESENZE -->
    <h4 class="text-lg font-bold text-gray-800 mt-6 border-t pt-4">3. Log e Tracciabilità</h4>
    <div class="grid grid-cols-2 gap-2 mt-4">
        <button id="show-attendees-btn" class="py-2 px-2 rounded-xl text-blue-700 border border-blue-700 bg-white hover:bg-blue-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            Mostra Lista Presenti
        </button>
        <button id="show-deliberations-btn" class="py-2 px-2 rounded-xl text-purple-700 border border-purple-700 bg-white hover:bg-purple-50 transition duration-150 ease-in-out font-semibold text-sm shadow-sm">
            Mostra Log Storico
        </button>
    </div>
</div>

<!-- Script Logica Applicativa (Supabase) -->
<script>
    // --- CONFIGURAZIONE SUPABASE ---
    // Questi valori sono stati inseriti dall'utente e devono essere corretti
    const SUPABASE_URL = 'https://fiwxcvafquxhkmulivgp.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpd3hjdmFmcXV4aGttdWxpdmdwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyOTIyMzQsImV4cCI6MjA3Njg2ODIzNH0.4Lhb5V0Du9IfQ_eYRF6So4PYRKCW0gMQuNJ16PvDt8'; 

    // --- INIZIALIZZAZIONE ---
    let supabase;
    
    try {
        if (!SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'LA_TUA_CHIAVE_ANON_PUBBLICA_REALE') {
            throw new Error("Errore: Chiave API Supabase non configurata.");
        }
        // Inizializza il client Supabase
        supabase = supabaseClient.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log("Supabase Client inizializzato con successo."); // Messaggio di conferma
        
    } catch (e) {
        document.getElementById('main-content').innerHTML = `
            <h2 class="text-2xl font-extrabold text-red-700 text-center mb-6">ERRORE DI CONFIGURAZIONE</h2>
            <p class="text-gray-700 mb-4 text-center">Impossibile connettersi a Supabase. Controlla il link e la chiave API. (${e.message})</p>
        `;
        throw new Error("Supabase non inizializzato.");
    }
    
    // Stato dell'Applicazione
    let userId = null;
    let isRegistered = false;
    let isVotingActive = false;
    let hasVotedInCurrentRound = false;
    let votingResults = { Favorevole: 0, Contrario: 0, Astenuto: 0 };
    let requiredCode = null; 
    let isViewingLog = false; 
    let isAdminRole = false; 
    let lastResetId = 0;

    // Elementi UI
    const mainContentEl = document.getElementById('main-content');
    const adminPanelEl = document.getElementById('admin-panel');
    const toggleVotingBtn = document.getElementById('toggle-voting-btn');
    const resetResultsBtn = document.getElementById('reset-results-btn');
    const updateCodeBtn = document.getElementById('update-code-btn'); 
    const adminUserIdEl = document.getElementById('admin-user-id');
    const votingStatusTextEl = document.getElementById('voting-status-text');
    const currentRequiredCodeEl = document.getElementById('current-required-code'); 
    const showAttendeesBtn = document.getElementById('show-attendees-btn'); 
    const showDeliberationsBtn = document.getElementById('show-deliberations-btn'); 

    // --- FUNZIONI DI UTILITÀ ---
    
    // Funzione per generare un ID Utente casuale e persistente
    function getUserId() {
        let uid = localStorage.getItem('votingAppUserId');
        if (!uid) {
            uid = crypto.randomUUID();
            localStorage.setItem('votingAppUserId', uid);
        }
        return uid;
    }

    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    }

    function formatTimestamp(timestampStr) {
        if (!timestampStr) return 'N/A';
        const date = new Date(timestampStr);
        return date.toLocaleDateString('it-IT', {
            year: 'numeric', month: '2-digit', day: '2-digit', 
            hour: '2-digit', minute: '2-digit', second: '2-digit'
        });
    }

    function showMessage(message, isError = false) {
        const type = isError ? 'bg-red-500' : 'bg-green-500';
        const messageEl = document.createElement('div');
        messageEl.className = `fixed top-5 left-1/2 transform -translate-x-1/2 p-3 rounded-lg text-white font-semibold ${type} shadow-xl z-50 transition-opacity duration-300`;
        messageEl.textContent = message;
        document.body.appendChild(messageEl);

        setTimeout(() => {
            messageEl.style.opacity = '0';
            messageEl.addEventListener('transitionend', () => messageEl.remove());
        }, 3000);
    }
    
    // --- FUNZIONI DI INIZIALIZZAZIONE ---

    function initApp() {
        userId = getUserId();
        isAdminRole = getUrlParameter('role') === 'admin';
        
        const adminIdDisplay = userId.substring(0, 10) + '...';
        adminUserIdEl.textContent = adminIdDisplay;

        if (isAdminRole) {
            adminPanelEl.classList.remove('hidden');
        }
        
        // Inizializza i listener per i pulsanti Admin
        if (adminPanelEl) { 
            toggleVotingBtn.addEventListener('click', handleAdminToggle);
            resetResultsBtn.addEventListener('click', handleResetResults);
            updateCodeBtn.addEventListener('click', handleAdminCodeUpdate); 
            showAttendeesBtn.addEventListener('click', showAttendeesList); 
            showDeliberationsBtn.addEventListener('click', showDeliberationsLog); 
        }

        // Avvia l'ascolto in tempo reale (Supabase Realtime)
        startRealtimeListening();
    }
    
    // ASCOLTO IN TEMPO REALE CON SUPABASE
    function startRealtimeListening() {
        // 1. Ascolta i cambiamenti di stato (per admin)
        supabase
            .channel('settings_changes')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'settings' }, payload => {
                // Aggiorna lo stato globale quando le impostazioni cambiano
                fetchSettingsAndVotes();
            })
            .subscribe();

        // 2. Ascolta i nuovi voti (per tutti)
        supabase
            .channel('vote_changes')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'attendees' }, payload => {
                // Se un nuovo utente si registra, aggiorna il conteggio delle presenze
                fetchSettingsAndVotes();
            })
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'votes' }, payload => {
                // Aggiorna i risultati in tempo reale
                fetchSettingsAndVotes();
            })
            .subscribe();

        // Primo fetch per popolare l'interfaccia
        fetchSettingsAndVotes();
    }

    async function fetchSettingsAndVotes() {
        // Fetch Settings
        const { data: settingsData, error: settingsError } = await supabase
            .from('settings')
            .select('*')
            .limit(1)
            .single();

        if (settingsError && settingsError.code !== 'PGRST116') { 
            console.error("Errore fetch settings:", settingsError);
            return;
        }

        if (settingsData) {
            isVotingActive = settingsData.is_voting_active;
            // Garantisce che requiredCode sia una stringa per il confronto
            requiredCode = settingsData.required_code ? String(settingsData.required_code) : null; 
            lastResetId = settingsData.id;
        }

        // Fetch Votes Count
        const { data: votesData, error: votesError } = await supabase
            .rpc('get_vote_counts');
            
        if (votesError) {
            console.error("Errore fetch votes:", votesError);
            return;
        }
        
        // Aggiorna i risultati
        votingResults = {
            Favorevole: votesData.find(r => r.vote === 'Favorevole')?.count || 0,
            Contrario: votesData.find(r => r.vote === 'Contrario')?.count || 0,
            Astenuto: votesData.find(r => r.vote === 'Astenuto')?.count || 0,
        };
        
        // Aggiorna lo stato locale dell'utente
        await checkUserVotedStatus();

        // Rendering dell'interfaccia
        renderApp();

        // Aggiorna il pannello Admin
        if (isAdminRole) {
            votingStatusTextEl.textContent = isVotingActive ? 'ATTIVO' : 'DISATTIVO';
            votingStatusTextEl.className = isVotingActive ? 'font-bold text-green-600' : 'font-bold text-red-600';
            toggleVotingBtn.textContent = isVotingActive ? 'Disattiva Votazione' : 'Attiva Votazione';
            toggleVotingBtn.className = isVotingActive ? 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-green-600 hover:bg-green-700 shadow-md' : 'w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-red-600 hover:bg-red-700 shadow-md';
            
            currentRequiredCodeEl.textContent = requiredCode || 'Nessuno';
        }
    }

    async function checkUserVotedStatus() {
        // 1. Controlla lo stato di registrazione (registrato in 'attendees')
        const { data: regData, error: regError } = await supabase
            .from('attendees')
            .select('id')
            .eq('user_id', userId)
            .limit(1);

        if (regError) {
            console.error("Errore check registrazione:", regError);
        } else {
            isRegistered = regData.length > 0;
        }
        
        // 2. Controlla se ha votato (in 'votes')
        const { data: voteData, error: voteError } = await supabase
            .from('votes')
            .select('id')
            .eq('user_id', userId)
            .limit(1);

        if (voteError) {
            console.error("Errore check voto:", voteError);
        } else {
            hasVotedInCurrentRound = voteData.length > 0;
        }
    }
    
    // --- FUNZIONI DI AZIONE DELL'UTENTE ---

    async function handleRegistration() {
        const nome = document.getElementById('nome').value.trim();
        const cognome = document.getElementById('cognome').value.trim();
        const codice = document.getElementById('codice').value.trim();

        if (!nome || !cognome || !codice) {
            showMessage("Per favore, compila tutti i campi.", true);
            return;
        }

        if (!requiredCode) {
            showMessage("L'amministratore non ha ancora impostato il codice di accesso.", true);
            return;
        }

        // Il codice in Supabase è gestito come testo
        if (codice !== requiredCode) {
            showMessage("Codice univoco errato. Per favore, verifica.", true);
            return;
        }
        
        // Insert new attendee
        const { error } = await supabase
            .from('attendees')
            .insert({ user_id: userId, nome: nome, cognome: cognome, codice: codice });
            
        if (error) {
            if (error.code === '23505') { // Violazione di UNIQUE constraint
                isRegistered = true;
                showMessage("Sei già stato registrato. Passaggio alla votazione.");
                renderApp();
                return;
            }
            console.error("Errore durante la registrazione: ", error);
            showMessage("Errore nel salvataggio della registrazione. Riprova.", true);
        } else {
            isRegistered = true;
            showMessage(`Registrazione di ${nome} ${cognome} completata! Benvenuto/a.`);
            renderApp();
        }
    }

    async function handleVote(choice) {
        if (!isVotingActive) {
            showMessage("La votazione è attualmente disattivata dall'amministrazione.", true);
            return;
        }
        if (hasVotedInCurrentRound) {
            showMessage("Hai già espresso il tuo voto in questa sessione. Attendi il prossimo voto.", true);
            return;
        }

        const { error } = await supabase
            .from('votes')
            .insert({ user_id: userId, vote: choice });

        if (error) {
            if (error.code === '23505') { // Violazione UNIQUE
                hasVotedInCurrentRound = true;
                showMessage("Hai già votato per questa mozione.", true);
                renderApp();
                return;
            }
            console.error("Errore durante la votazione: ", error);
            showMessage("Errore durante l'invio del voto. Riprova.", true);
        } else {
            hasVotedInCurrentRound = true;
            showMessage(`Voto espresso: ${choice}. Grazie!`);
            // Realtime listener aggiorna l'interfaccia automaticamente
        }
    }
    
    // --- FUNZIONI DI AZIONE ADMIN ---
    
    async function handleAdminCodeUpdate() {
        if (!isAdminRole) return;
        
        const newCode = document.getElementById('admin-set-code').value.trim();
        const codeToSave = newCode || null; // Salva NULL se vuoto

        const { error } = await supabase
            .from('settings')
            .upsert({ id: lastResetId || 1, required_code: codeToSave });

        if (error) {
            console.error("Errore nell'aggiornamento del codice Admin: ", error);
            showMessage("Errore nel salvataggio del codice.", true);
        } else {
            showMessage(`Codice impostato a ${codeToSave || 'VUOTO'}.`);
        }
    }

    async function handleAdminToggle() {
        if (!isAdminRole) return; 
        
        const newState = !isVotingActive;
        
        const { error } = await supabase
            .from('settings')
            .upsert({ id: lastResetId || 1, is_voting_active: newState });

        if (error) {
            console.error("Errore nel toggle Admin: ", error);
            showMessage("Errore nel cambio stato votazione.", true);
        } else {
            showMessage(`Votazione ${newState ? 'ATTIVATA' : 'DISATTIVATA'}.`);
        }
    }

    async function handleResetResults() {
        if (!isAdminRole) return; 

        try {
            // 1. Ottieni il conteggio finale e i presenti
            const { data: finalVotes, error: votesError } = await supabase.rpc('get_vote_counts');
            const { count: attendeesCount, error: attendeesError } = await supabase.from('attendees').select('*', { count: 'exact', head: true });

            if (votesError || attendeesError) {
                throw new Error("Errore nel recupero dei conteggi finali.");
            }

            // 2. Salva nel Log Storico
            const logEntry = {
                attendees_count: attendeesCount,
                favorevole: finalVotes.find(r => r.vote === 'Favorevole')?.count || 0,
                contrario: finalVotes.find(r => r.vote === 'Contrario')?.count || 0,
                astenuto: finalVotes.find(r => r.vote === 'Astenuto')?.count || 0,
            };
            const { error: logError } = await supabase.from('log').insert(logEntry);
            if (logError) throw new Error("Errore nel salvataggio del log storico.");

            // 3. Cancella i voti
            const { error: deleteVotesError } = await supabase.from('votes').delete().neq('id', 0); // Cancella tutto
            if (deleteVotesError) throw new Error("Errore nella cancellazione dei voti.");
            
            // 4. Cancella i presenti (per la prossima riunione)
            const { error: deleteAttendeesError } = await supabase.from('attendees').delete().neq('id', 0);
            if (deleteAttendeesError) throw new Error("Errore nella cancellazione dei presenti.");
            
            // 5. Aggiorna lo stato Admin (per forzare il refresh locale)
            const { error: settingsUpdateError } = await supabase
                .from('settings')
                .upsert({ id: lastResetId || 1, last_reset_at: new Date().toISOString() });
            
            if (settingsUpdateError) throw new Error("Errore aggiornamento timestamp reset.");

            showMessage("Voti e Presenze resettati. Log salvato con successo.");
            
            // Forziamo il reset dello stato locale per l'admin
            hasVotedInCurrentRound = false;
            fetchSettingsAndVotes();

        } catch (e) {
            console.error("Errore nel reset dei voti: ", e.message);
            showMessage(`Errore: ${e.message}`, true);
        }
    }
    
    // --- FUNZIONI DI VISUALIZZAZIONE ADMIN ---

    async function showAttendeesList() {
        if (!isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<p class="text-center text-gray-500">Caricamento lista presenti...</p>';

        try {
            const { data, error } = await supabase
                .from('attendees')
                .select('nome, cognome, created_at')
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            let listHtml = data.length === 0 
                ? '<p class="text-center text-gray-500 p-4">Nessun docente registrato finora.</p>'
                : `<ul class="log-list divide-y divide-gray-200">
                    ${data.map(row => {
                        return `
                            <li class="p-3 flex justify-between items-center text-sm">
                                <span class="font-semibold text-gray-900">${row.cognome} ${row.nome}</span>
                                <span class="text-gray-500 text-xs">${formatTimestamp(row.created_at)}</span>
                            </li>
                        `;
                    }).join('')}
                </ul>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Lista Docenti Presenti (${data.length})</h2>
                ${listHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                fetchSettingsAndVotes();
            });

        } catch (e) {
            console.error("Errore nel caricamento lista presenti:", e.message);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento della lista.</p>';
        }
    }

    async function showDeliberationsLog() {
        if (!isAdminRole) return;
        isViewingLog = true;
        mainContentEl.innerHTML = '<p class="text-center text-gray-500">Caricamento log storico delle delibere...</p>';
        
        try {
            const { data, error } = await supabase
                .from('log')
                .select('created_at, attendees_count, favorevole, contrario, astenuto')
                .order('created_at', { ascending: false });

            if (error) throw error;
            
            let logHtml = data.length === 0
                ? '<p class="text-center text-gray-500 p-4">Nessuna votazione storica salvata finora.</p>'
                : `<div class="log-list space-y-4">
                    ${data.map((row, index) => { 
                        const totalVoti = row.favorevole + row.contrario + row.astenuto;
                        return `
                            <div class="p-3 border rounded-lg shadow-sm bg-white">
                                <p class="text-sm font-bold text-gray-800 mb-1">Delibera #${data.length - index} - Voti: ${totalVoti} / Presenti: ${row.attendees_count || 'N/A'}</p>
                                <p class="text-xs text-gray-500 mb-2">${formatTimestamp(row.created_at)}</p>
                                <div class="grid grid-cols-3 gap-1 text-xs font-semibold">
                                    <span class="p-1 bg-green-100 text-green-700 rounded text-center">F: ${row.favorevole}</span>
                                    <span class="p-1 bg-red-100 text-red-700 rounded text-center">C: ${row.contrario}</span>
                                    <span class="p-1 bg-yellow-100 text-yellow-700 rounded text-center">A: ${row.astenuto}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            mainContentEl.innerHTML = `
                <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-4">Log Storico Votazioni (${data.length})</h2>
                ${logHtml}
                <button id="back-to-vote-btn" class="w-full mt-4 py-2 px-4 rounded-xl text-white font-semibold bg-blue-500 hover:bg-blue-600">
                    Torna alla Votazione
                </button>
            `;
            document.getElementById('back-to-vote-btn').addEventListener('click', () => {
                isViewingLog = false;
                fetchSettingsAndVotes();
            });

        } catch (e) {
            console.error("Errore nel caricamento log storico:", e.message);
            mainContentEl.innerHTML = '<p class="text-center text-red-500">Errore nel caricamento del log storico.</p>';
        }
    }

    // --- FUNZIONE DI RENDERING (Mostra la pagina corretta) ---
    
    function renderApp() {
        if (isViewingLog) return; 
        
        mainContentEl.innerHTML = ''; 

        if (!isRegistered) {
            renderRegistrationPage(); 
        } else {
            renderVotingPage(); 
        }
    }

    function renderRegistrationPage() {
        const savedNome = document.getElementById('nome')?.value || '';
        const savedCognome = document.getElementById('cognome')?.value || '';
        const savedCodice = document.getElementById('codice')?.value || '';
        
        const codeStatus = requiredCode 
            ? `<p class="text-sm text-green-600 text-center font-semibold mb-4">Codice di accesso ATTIVO: ${requiredCode}.</p>`
            : '<p class="text-sm text-red-600 text-center font-semibold mb-4">Codice di accesso NON ancora impostato dall\'amministratore.</p>';

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6">
                <span class="text-blue-600">Registro</span> Presenze Collegio
            </h2>
            <div class="p-3 mb-4 rounded-xl bg-gray-50 border border-gray-200">
                <p class="text-sm text-gray-600 text-center">ID Dispositivo: <span class="font-mono text-xs bg-gray-200 p-1 rounded">${userId || 'Caricamento...'}</span></p>
            </div>
            ${isRegistered ? 
                '<p class="text-lg text-green-600 font-bold text-center mb-4">Presenza Registrata. Vai al voto!</p>'
                : codeStatus
            }
            <div class="space-y-4">
                <input type="text" id="nome" placeholder="Nome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedNome}" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="cognome" placeholder="Cognome" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedCognome}" ${isRegistered ? 'disabled' : ''}/>
                <input type="text" id="codice" placeholder="Codice Univoco Collegio" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-blue-500 focus:border-blue-500 transition" value="${savedCodice}" ${isRegistered ? 'disabled' : ''}/>
                
                <button id="register-btn" class="w-full py-3 px-4 rounded-xl text-white font-semibold transition duration-150 ease-in-out bg-blue-600 hover:bg-blue-700 shadow-md hover:shadow-lg ${isRegistered ? 'opacity-50 cursor-not-allowed' : ''}" ${isRegistered ? 'disabled' : ''}>
                    Registra Presenza
                </button>
            </div>
        `;
        document.getElementById('register-btn')?.addEventListener('click', handleRegistration);
    }

    function renderVotingPage() {
        const statusClass = isVotingActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
        const statusText = isVotingActive ? 'Votazione Attiva: Esprimi il tuo voto.' : 'Votazione Chiusa: Attendi l\'attivazione.';
        const disabledClass = isVotingActive && !hasVotedInCurrentRound ? '' : 'opacity-50 cursor-not-allowed';
        const buttonDisabled = isVotingActive && !hasVotedInCurrentRound ? '' : 'disabled';
        
        let voteMessage = '';
        if (hasVotedInCurrentRound) {
            voteMessage = '<p class="text-center text-sm text-yellow-700 p-2 bg-yellow-50 rounded-lg">Hai già votato per la mozione corrente.</p>';
        }

        mainContentEl.innerHTML = `
            <h2 class="text-2xl font-extrabold text-gray-900 text-center mb-6">
                <span class="text-blue-600">Votazione</span> in Corso
            </h2>
            <div class="p-4 rounded-xl mb-6 font-semibold text-center ${statusClass}">
                ${statusText}
            </div>
            
            ${voteMessage}
            
            <div class="grid grid-cols-1 gap-4">
                <button data-vote="Favorevole" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-green-600 hover:bg-green-700 ${disabledClass} shadow-lg">
                    Favorevole (${votingResults.Favorevole})
                </button>
                <button data-vote="Contrario" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-white font-bold text-lg bg-red-600 hover:bg-red-700 ${disabledClass} shadow-lg">
                    Contrario (${votingResults.Contrario})
                </button>
                <button data-vote="Astenuto" ${buttonDisabled} class="vote-btn py-5 px-4 rounded-xl text-gray-800 font-bold text-lg bg-yellow-400 hover:bg-yellow-500 ${disabledClass} shadow-lg">
                    Astenuto (${votingResults.Astenuto})
                </button>
            </div>
        `;
        // Listener per i pulsanti di voto
        mainContentEl.querySelectorAll('.vote-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (!e.target.disabled) {
                    handleVote(e.target.dataset.vote);
                }
            });
        });
    }

    // Avvia l'app al caricamento
    document.addEventListener('DOMContentLoaded', initApp);
</script>
</body>
</html>
