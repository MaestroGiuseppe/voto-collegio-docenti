<!--
    APPLICAZIONE DI VOTAZIONE PER COLLEGIO DOCENTI
    INTEGRAZIONE SUPABASE REALTIME E FUNZIONI ADMIN
    ================================================
    Questa applicazione gestisce due viste:
    1. Votante (Docente): Registrazione, Votazione.
    2. Amministratore (Dirigente): Controllo stato, Inizio/Fine votazione, Reset.

    PRIMA DI UTILIZZARE:
    1. SOSTITUIRE I SEGUENTI PLACEHOLDER CON LE NUOVE CREDENZIALI DEL PROGETTO SUPABASE:
       - SUPABASE_URL
       - SUPABASE_API_KEY
    2. ASSICURARSI DI AVER ESEGUITO TUTTO LO SCRIPT SQL NEL NUOVO PROGETTO SUPABASE.
-->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Votazione Collegio Docenti</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Utilizzo del font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .main-container {
            min-height: 100vh;
        }
        /* Stili per il pulsante del voto attivo */
        .vote-button:not(.is-voted):hover {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .is-voted {
            border: 3px solid #2563eb; /* Anello blu quando selezionato */
            box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
            transform: scale(1.02);
        }
        /* Nasconde la scrollbar in alcune modalità per una pulizia visiva */
        body::-webkit-scrollbar {
            display: none;
        }
        body {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="main-container flex items-center justify-center">
        <!-- Il contenuto dell'app (interfaccia Docente o Dirigente) verrà iniettato qui -->
        <div id="content" class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Caricamento in corso...</h1>
        </div>
    </div>

    <!-- Libreria Lucide Icons (corretta) -->
    <script type="module">
        import { createIcons, LogOut, Check, X, Shield, Users, PieChart, Repeat, Plus, Minus, FileText } from 'https://cdn.jsdelivr.net/npm/lucide-esm@0.411.0/dist/lucide-esm.js';
        window.lucide = { createIcons, LogOut, Check, X, Shield, Users, PieChart, Repeat, Plus, Minus, FileText };
    </script>
    <!-- Supabase JS (corretta) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.2/dist/umd/supabase.min.js"></script>

    <script type="text/javascript">
        // ====================================================================
        // CONFIGURAZIONE SUPABASE (SOSTITUIRE CON I PROPRI VALORI)
        // ====================================================================
        const SUPABASE_URL = 'https://iuuvakwbuequapwoyddd.supabase.co'; // ES: 'https://xyz.supabase.co'
        const SUPABASE_API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dXZha3didWVxdWFwd295ZGRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMTE5ODEsImV4cCI6MjA3Njg4Nzk4MX0.c7BpXAk8hF0lijNnWaURjQxsZDBv66JvV8NJ1xxX-KI'; // ES: 'eyJhbGciOiJIUzI1NiI...'
        // ====================================================================

        let supabase = null;
        let isRegistered = false; // Stato di registrazione del docente
        let isVotingActive = false; // Stato della votazione (Admin)
        let userId = localStorage.getItem('voting_user_id') || null;

        /**
         * Inizializza Supabase e tenta il recupero dei dati.
         */
        function initializeSupabase() {
            try {
                if (SUPABASE_URL.includes('INSERISCI') || SUPABASE_API_KEY.includes('INSERISCI')) {
                    throw new Error("Credenziali Supabase mancanti. Aggiorna SUPABASE_URL e SUPABASE_API_KEY.");
                }

                supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_API_KEY, {
                    auth: { persistSession: false },
                });
                console.log('Supabase Client inizializzato con successo.');

                if (!userId) {
                    userId = crypto.randomUUID();
                    localStorage.setItem('voting_user_id', userId);
                }

                setupRealtimeListeners();
                fetchSettingsAndVotes();
                
                // Crea le icone Lucide all'avvio
                window.onload = () => {
                    if (window.lucide && window.lucide.createIcons) {
                        window.lucide.createIcons();
                    }
                };

            } catch (error) {
                console.error("Errore di inizializzazione Supabase:", error);
                document.getElementById('content').innerHTML = `
                    <div class="text-center p-6 bg-red-100 border border-red-400 text-red-700 rounded-lg shadow-md">
                        <p class="font-bold mb-2">ERRORE CRITICO DI CONFIGURAZIONE</p>
                        <p>${error.message}</p>
                        <p class="mt-4 text-sm">Controlla l'URL e la Chiave API nel file HTML.</p>
                    </div>
                `;
            }
        }

        /**
         * Imposta l'ascolto in tempo reale sui cambiamenti delle tabelle critiche.
         */
        function setupRealtimeListeners() {
            if (!supabase) return;
            console.log('Supabase Realtime Abilitato.');

            // Ascolta i cambiamenti nello stato di voto (tabella settings)
            supabase.channel('settings_changes')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'settings' }, (payload) => {
                    console.log('Settings changed:', payload);
                    isVotingActive = payload.new.is_voting_active;
                    // Forze il re-rendering dell'interfaccia corrente
                    if (document.location.search.includes('role=admin')) {
                        renderAdminInterface();
                        fetchVoteCounts();
                    } else {
                        renderDocenteInterface();
                    }
                })
                .subscribe();

            // Ascolta i cambiamenti nei voti e presenze (per l'Admin)
            if (document.location.search.includes('role=admin')) {
                supabase.channel('vote_changes')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'votes' }, (payload) => {
                        console.log('Votes changed:', payload);
                        fetchVoteCounts();
                    })
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'attendees' }, (payload) => {
                        console.log('Attendees changed:', payload);
                        fetchVoteCounts();
                    })
                    .subscribe();
            }
        }

        /**
         * Recupera lo stato di voto (isVotingActive) e lo stato di registrazione del docente.
         */
        async function fetchSettingsAndVotes() {
            if (!supabase) return;

            // 1. Fetch settings
            const { data: settingsData, error: settingsError } = await supabase
                .from('settings')
                .select('is_voting_active, required_code, id')
                .limit(1)
                .single();

            if (settingsError) {
                console.error("Errore fetch settings:", settingsError);
                // Permette all'admin di continuare anche se la prima riga non esiste
                if (settingsError.code === 'PGRST116') { // Nessuna riga trovata
                     isVotingActive = false; // Default: votazione inattiva
                } else if (settingsError.code === '401') {
                    // Errore 401: La chiave API è ancora bloccata, anche se il db è nuovo!
                    console.error("Errore 401: Accesso non autorizzato. Controlla la chiave API e le politiche RLS.");
                }
            } else {
                isVotingActive = settingsData.is_voting_active;
            }

            // 2. Controlla la registrazione
            if (!document.location.search.includes('role=admin')) {
                const { data: registrationData } = await supabase
                    .from('attendees')
                    .select('id')
                    .eq('unique_id', userId)
                    .limit(1);
                
                isRegistered = registrationData && registrationData.length > 0;
            }


            // 3. Renderizza l'interfaccia corretta
            const isAdmin = document.location.search.includes('role=admin');
            if (isAdmin) {
                renderAdminInterface();
                fetchVoteCounts();
            } else {
                renderDocenteInterface();
            }

            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        // ====================================================================
        // LOGICA DI VOTO E REGISTRAZIONE
        // ====================================================================

        /**
         * Gestisce la registrazione del docente.
         */
        async function registerDocente() {
            const name = document.getElementById('nome').value.trim();
            const surname = document.getElementById('cognome').value.trim();
            const code = document.getElementById('code').value.trim();

            if (!name || !surname || !code) {
                showMessage("Per favore, compila tutti i campi.", 'error');
                return;
            }
            
            // 1. Verifica il codice
            const { data: settings, error: settingsError } = await supabase
                .from('settings')
                .select('required_code')
                .eq('id', 1)
                .single();

            if (settingsError || settings.required_code !== code) {
                showMessage("Codice univoco errato. Riprova.", 'error');
                return;
            }

            // 2. Registra l'utente
            const { error: insertError } = await supabase
                .from('attendees')
                .insert({
                    unique_id: userId,
                    name: name,
                    surname: surname
                });

            if (insertError) {
                // Se l'utente è già registrato (unique_id duplicato), non è un errore critico
                if (insertError.code !== '23505') { // 23505 = duplicato
                    showMessage(`Errore di registrazione: ${insertError.message}`, 'error');
                    return;
                }
            }

            isRegistered = true;
            showMessage("Registrazione completata con successo!", 'success');
            renderDocenteInterface();
        }

        /**
         * Registra il voto dell'utente.
         * @param {string} voteValue - 'Favorevole', 'Contrario', 'Astenuto'.
         */
        async function submitVote(voteValue) {
            if (!isVotingActive) {
                showMessage("La votazione è attualmente chiusa. Attendi istruzioni dal Dirigente.", 'warning');
                return;
            }
            if (!isRegistered) {
                showMessage("Devi prima registrarti per votare.", 'error');
                return;
            }

            const voteData = {
                unique_id: userId,
                vote: voteValue
            };

            const { error } = await supabase
                .from('votes')
                .upsert(voteData, { onConflict: 'unique_id' }); // Aggiorna se l'utente ha già votato

            if (error) {
                showMessage(`Errore durante il voto: ${error.message}`, 'error');
            } else {
                highlightVotedButton(voteValue);
                showMessage(`Il tuo voto: "${voteValue}" è stato registrato!`, 'success');
            }
        }

        /**
         * Evidenzia il pulsante del voto selezionato.
         * @param {string} voteValue
         */
        function highlightVotedButton(voteValue) {
            const buttons = document.querySelectorAll('.vote-button');
            buttons.forEach(btn => {
                btn.classList.remove('is-voted');
                if (btn.dataset.vote === voteValue) {
                    btn.classList.add('is-voted');
                }
            });
        }

        // ====================================================================
        // FUNZIONI ADMIN
        // ====================================================================

        /**
         * Aggiorna lo stato di voto e il codice tramite una funzione di database.
         * @param {boolean} isActive - Stato della votazione (true/false)
         * @param {string} newCode - Codice per la registrazione
         */
        async function updateAdminSettings(isActive, newCode) {
            if (!supabase) return;
            const finalCode = newCode || null;

            // Chiama la funzione di database (che ha i permessi di scrittura)
            const { error } = await supabase.rpc('update_admin_settings', {
                new_code: finalCode,
                is_voting_active: isActive
            });

            if (error) {
                showMessage(`Errore RPC: ${error.message}`, 'error');
                console.error("Errore update settings:", error);
            } else {
                isVotingActive = isActive;
                showMessage(`Votazione ${isActive ? 'APERTA' : 'CHIUSA'}. Nuovo codice impostato.`, 'success');
                // Forza un refresh per aggiornare tutti gli stati
                fetchSettingsAndVotes();
            }
        }

        /**
         * Recupera il conteggio dei voti e delle presenze tramite una funzione di database.
         */
        async function fetchVoteCounts() {
            if (!supabase) return;

            const { data, error } = await supabase.rpc('get_vote_counts');

            if (error) {
                console.error("Errore fetch vote counts:", error);
                document.getElementById('stats-panel').innerHTML = `<p class="text-red-500">Errore nel caricare i risultati: ${error.message}</p>`;
                return;
            }

            const stats = data[0];
            
            // Aggiorna l'interfaccia
            const statsHtml = `
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                    <div class="p-4 bg-blue-50 rounded-lg shadow-inner">
                        <p class="text-3xl font-bold text-blue-600">${stats.attendee_count || 0}</p>
                        <p class="text-sm text-gray-600">Docenti Registrati</p>
                    </div>
                    <div class="p-4 bg-purple-50 rounded-lg shadow-inner">
                        <p class="text-3xl font-bold text-purple-600">${stats.total_votes || 0}</p>
                        <p class="text-sm text-gray-600">Voti Totali Espressi</p>
                    </div>
                    <div class="p-4 bg-green-50 rounded-lg shadow-inner">
                        <p class="text-3xl font-bold text-green-600">${stats.yes_votes || 0}</p>
                        <p class="text-sm text-gray-600">Voti "Favorevole"</p>
                    </div>
                    <div class="p-4 bg-red-50 rounded-lg shadow-inner">
                        <p class="text-3xl font-bold text-red-600">${stats.no_votes || 0}</p>
                        <p class="text-sm text-gray-600">Voti "Contrario/Astenuto"</p>
                    </div>
                </div>
                <p class="mt-4 text-center text-sm text-gray-500">
                    Stato attuale: <span class="font-semibold text-${isVotingActive ? 'green' : 'red'}-600">${isVotingActive ? 'VOTAZIONE APERTA' : 'VOTAZIONE CHIUSA'}</span>
                </p>
            `;
            document.getElementById('stats-panel').innerHTML = statsHtml;
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        /**
         * Resetta solo i voti e le presenze, e salva il log. (Per delibera successiva)
         */
        async function resetVotesAndLog() {
            if (!confirm("Sei sicuro di voler chiudere il voto, salvare il log e resettare tutti i voti e le presenze?")) return;

            // 1. Chiude la votazione (sicurezza)
            await updateAdminSettings(false, null);

            // 2. Chiama la funzione per salvare il log e resettare i dati
            // NOTA: Questa funzione deve essere definita nell'editor SQL (non è una RPC di default)
            const { data: voteCounts, error: countError } = await supabase.rpc('get_vote_counts');
            
            if (countError) {
                showMessage("Errore nel recuperare i conteggi per il log.", 'error');
                return;
            }
            
            const stats = voteCounts[0];
            const logEntry = {
                timestamp: new Date().toISOString(),
                attendees_count: stats.attendee_count,
                total_votes: stats.total_votes,
                yes_votes: stats.yes_votes,
                no_votes: stats.no_votes,
                status: 'DELIBERA SALVATA E VOTO RESETTATO'
            };

            // 3. Salva il log
            await supabase.from('log').insert(logEntry);

            // 4. Elimina voti e presenze
            await supabase.from('votes').delete().neq('unique_id', 'admin');
            await supabase.from('attendees').delete().neq('unique_id', 'admin');

            showMessage("Voti, Presenze e Log salvati con successo. Pronto per la prossima Delibera.", 'success');
            fetchVoteCounts();
        }

        /**
         * Reset totale: elimina tutte le tabelle (solo per nuovo collegio)
         */
        async function resetFullProject() {
            if (!confirm("AVVERTIMENTO CRITICO: Sei sicuro di voler ELIMINARE TUTTI i dati (voti, presenze, log e configurazione) e resettare il progetto? Questo è IRREVERSIBILE!")) return;
            
            // Per motivi di sicurezza e complessità, si reindirizza l'admin all'editor SQL per l'operazione
            showMessage("Per un reset totale e sicuro (eliminazione dello schema), accedi all'Editor SQL di Supabase e incolla lo script di reset fornito.", 'error');

            // Script suggerito per l'utente (non eseguito dal codice JS)
            const resetScript = `
                -- ELIMINA TUTTI I DATI E STRUTTURE
                DROP TABLE IF EXISTS public.votes CASCADE;
                DROP TABLE IF EXISTS public.attendees CASCADE;
                DROP TABLE IF EXISTS public.log CASCADE;
                DROP TABLE IF EXISTS public.settings CASCADE;
                -- Esegui poi lo script SQL iniziale per ricreare tutto.
            `;
            console.log("SCRIPT DI RESET TOTALE SUGGERITO:", resetScript);
        }

        // ====================================================================
        // FUNZIONI DI UTILITY E RENDERING
        // ====================================================================

        /**
         * Mostra un messaggio di feedback all'utente.
         * @param {string} message
         * @param {('success'|'error'|'warning')} type
         */
        function showMessage(message, type) {
            const messageContainer = document.getElementById('message-container') || document.createElement('div');
            messageContainer.id = 'message-container';
            messageContainer.className = `p-4 rounded-lg shadow-md mb-6 transition-all duration-300 ${
                type === 'success' ? 'bg-green-100 border-green-400 text-green-700' :
                type === 'error' ? 'bg-red-100 border-red-400 text-red-700' :
                'bg-yellow-100 border-yellow-400 text-yellow-700'
            } border`;
            messageContainer.innerHTML = `<p class="font-semibold">${message}</p>`;

            const contentDiv = document.getElementById('content');
            if (document.getElementById('message-container')) {
                document.getElementById('message-container').replaceWith(messageContainer);
            } else if (contentDiv) {
                contentDiv.prepend(messageContainer);
            }
            setTimeout(() => {
                messageContainer.remove();
            }, 5000);
        }

        /**
         * Rendere l'interfaccia Docente (Registrazione o Voto).
         */
        async function renderDocenteInterface() {
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = ''; // Pulisce il contenuto

            if (!isRegistered) {
                // Interfaccia di Registrazione
                contentDiv.innerHTML = `
                    <h2 class="text-4xl font-extrabold text-blue-700 mb-8 text-center">Registrazione Collegio Docenti</h2>
                    <div class="space-y-6">
                        <input id="nome" type="text" placeholder="Nome" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" />
                        <input id="cognome" type="text" placeholder="Cognome" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" />
                        <input id="code" type="password" placeholder="Codice Univoco Dirigente" class="w-full p-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-lg" />
                    </div>
                    <button id="register-btn" onclick="registerDocente()" class="w-full mt-8 py-4 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition duration-200 shadow-xl">
                        Registrati e Accedi al Voto
                    </button>
                    <p class="mt-4 text-center text-sm text-gray-500">
                        Il tuo ID Univoco (non modificabile) è: ${userId}
                    </p>
                `;
                document.getElementById('register-btn').addEventListener('click', () => {
                    // La logica di disabilitazione/abilitazione è gestita all'interno di registerDocente
                    // ma un minimo di controllo visivo sull'input è dato qui per pulizia
                });

            } else {
                // Interfaccia di Voto
                
                // Controlla se l'utente ha già votato (per evidenziare il bottone)
                let lastVote = null;
                const { data: voteData } = await supabase.from('votes').select('vote').eq('unique_id', userId).limit(1);
                if (voteData && voteData.length > 0) {
                    lastVote = voteData[0].vote;
                }

                contentDiv.innerHTML = `
                    <h2 class="text-4xl font-extrabold text-blue-700 mb-4 text-center">Esprimi il tuo Voto</h2>
                    <p class="text-center text-gray-600 mb-10 text-xl font-medium">Delibera: **[INSERIRE NOME DELIBERA QUI]**</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <button data-vote="Favorevole" onclick="submitVote('Favorevole')" class="vote-button flex flex-col items-center justify-center p-8 bg-green-500 text-white rounded-xl text-2xl font-bold transition duration-300 transform ${lastVote === 'Favorevole' ? 'is-voted' : ''}">
                            <i data-lucide="check" class="w-12 h-12 mb-2"></i>
                            Favorevole
                        </button>
                        <button data-vote="Contrario" onclick="submitVote('Contrario')" class="vote-button flex flex-col items-center justify-center p-8 bg-red-500 text-white rounded-xl text-2xl font-bold transition duration-300 transform ${lastVote === 'Contrario' ? 'is-voted' : ''}">
                            <i data-lucide="x" class="w-12 h-12 mb-2"></i>
                            Contrario/a
                        </button>
                        <button data-vote="Astenuto" onclick="submitVote('Astenuto')" class="vote-button flex flex-col items-center justify-center p-8 bg-yellow-500 text-white rounded-xl text-2xl font-bold transition duration-300 transform ${lastVote === 'Astenuto' ? 'is-voted' : ''}">
                            <i data-lucide="minus" class="w-12 h-12 mb-2"></i>
                            Astenuto/a
                        </button>
                    </div>

                    <div class="mt-8 p-4 bg-gray-50 rounded-lg shadow-inner">
                        <p class="font-semibold text-lg mb-2">Stato Votazione:</p>
                        <p id="voting-status" class="text-xl font-bold text-center">
                            ${isVotingActive ? 
                                '<span class="text-green-600 flex items-center justify-center"><i data-lucide="check" class="w-6 h-6 mr-2"></i> VOTAZIONE APERTA</span>' : 
                                '<span class="text-red-600 flex items-center justify-center"><i data-lucide="x" class="w-6 h-6 mr-2"></i> VOTAZIONE CHIUSA</span>'
                            }
                        </p>
                    </div>
                `;
                 // Re-highlighting dopo il rendering (per sicurezza)
                if(lastVote) highlightVotedButton(lastVote);
            }
             if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }

        /**
         * Rendere l'interfaccia Dirigente (Amministratore).
         */
        async function renderAdminInterface() {
            const contentDiv = document.getElementById('content');
            
            // Fetch del codice attuale
            const { data: settings } = await supabase
                .from('settings')
                .select('required_code')
                .eq('id', 1)
                .single();

            const currentCode = settings ? settings.required_code : 'N/D';

            contentDiv.innerHTML = `
                <h2 class="text-4xl font-extrabold text-indigo-700 mb-8 text-center flex items-center justify-center">
                    <i data-lucide="shield" class="w-10 h-10 mr-3"></i>
                    Pannello Amministratore
                </h2>
                
                <!-- STATISTICHE IN TEMPO REALE -->
                <div class="mb-10 p-6 bg-gray-50 rounded-xl shadow-lg">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="pie-chart" class="w-6 h-6 mr-2 text-indigo-500"></i>
                        Risultati in Tempo Reale
                    </h3>
                    <div id="stats-panel">
                        <!-- Qui verranno iniettate le statistiche da fetchVoteCounts() -->
                        <p class="text-center text-gray-500">Caricamento statistiche...</p>
                    </div>
                </div>

                <!-- CONTROLLI AMMINISTRATIVI -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

                    <!-- SEZIONE 1: CONTROLLO VOTO -->
                    <div class="p-6 bg-white border border-indigo-200 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                            <i data-lucide="repeat" class="w-5 h-5 mr-2"></i>
                            Stato Votazione e Codice
                        </h3>
                        <div class="flex items-center space-x-2 mb-4">
                            <label for="new-code" class="text-gray-700">Codice Attuale:</label>
                            <span class="font-mono bg-yellow-100 text-yellow-800 p-1 rounded text-sm">${currentCode || 'NON IMPOSTATO'}</span>
                        </div>
                        <input id="new-code" type="text" placeholder="Nuovo Codice Univoco" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" />
                        
                        <div class="space-y-3">
                            <button onclick="updateAdminSettings(true, document.getElementById('new-code').value)" class="w-full py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition duration-200 shadow-lg flex items-center justify-center">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                                APRI VOTAZIONE
                            </button>
                            <button onclick="updateAdminSettings(false, document.getElementById('new-code').value)" class="w-full py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-200 shadow-lg flex items-center justify-center">
                                <i data-lucide="minus" class="w-5 h-5 mr-2"></i>
                                CHIUDI VOTAZIONE
                            </button>
                        </div>
                    </div>
                    
                    <!-- SEZIONE 2: PULIZIA E LOG -->
                    <div class="p-6 bg-white border border-indigo-200 rounded-xl shadow-md">
                        <h3 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                            <i data-lucide="file-text" class="w-5 h-5 mr-2"></i>
                            Gestione Delibere e Reset
                        </h3>
                        <p class="text-sm text-gray-600 mb-4">Questa operazione salva il conteggio finale nel Log, azzera i voti e le presenze per la delibera successiva.</p>
                        <button onclick="resetVotesAndLog()" class="w-full py-3 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition duration-200 shadow-lg flex items-center justify-center mb-6">
                            Resetta Voti e Salva Log
                        </button>

                        <h3 class="text-xl font-bold text-red-600 mb-4 flex items-center">
                            <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                            Reset Totale
                        </h3>
                        <p class="text-sm text-red-600 mb-4 font-semibold">ATTENZIONE: Elimina TUTTI i dati. Da usare solo per l'inizio di un NUOVO Collegio.</p>
                        <button onclick="resetFullProject()" class="w-full py-3 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition duration-200 shadow-lg flex items-center justify-center">
                            RESET TOTALE PROGETTO
                        </button>
                    </div>

                </div>

                <div class="mt-8 p-4 bg-indigo-50 border-t border-indigo-300 text-sm text-center text-indigo-700 rounded-b-xl">
                    <p>Accesso Admin: L'URL deve contenere <code>?role=admin</code></p>
                </div>
            `;
            if (window.lucide && window.lucide.createIcons) {
                window.lucide.createIcons();
            }
        }


        // ====================================================================
        // LOGICA PRINCIPALE
        // ====================================================================

        document.addEventListener('DOMContentLoaded', () => {
            const isAdmin = document.location.search.includes('role=admin');
            
            // Inizializza Supabase e carica i dati
            initializeSupabase();

            // Rileva l'interfaccia e imposta il re-rendering
            if (isAdmin) {
                document.title = "Admin - Votazione Collegio";
                // L'admin viene renderizzato dopo il fetchSettingsAndVotes
            } else {
                document.title = "Docente - Votazione Collegio";
                // Il docente viene renderizzato dopo il fetchSettingsAndVotes
            }
        });
    </script>
</body>
</html>
